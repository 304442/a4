<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PocketBase Full Setup</title>
    <script src="https://cdn.jsdelivr.net/npm/pocketbase@latest/dist/pocketbase.umd.js"></script>
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; max-width: 800px; margin: auto; }
        label { display: block; margin-top: 10px; }
        input[type="text"], input[type="password"], textarea { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; }
        button { padding: 10px 15px; margin-top: 20px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background-color: #0056b3; }
        pre { background-color: #f4f4f4; padding: 10px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; max-height: 400px; overflow-y: auto;}
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        .info { color: #333; }
    </style>
</head>
<body>
    <h1>PocketBase Full Setup (Collections & Seed)</h1>
    <p>This script will attempt to:
        <ol>
            <li>Create or update collections based on the provided schema.</li>
            <li>Seed initial data into the 'planner_templates' collection (if not already present by template_name).</li>
        </ol>
       <strong>Review the schema and seed data in the textareas before running.</strong>
    </p>

    <div>
        <label for="pbUrl">PocketBase URL:</label>
        <input type="text" id="pbUrl" value="http://127.0.0.1:8090">
    </div>
    <div>
        <label for="adminEmail">Admin Email:</label>
        <input type="text" id="adminEmail" placeholder="your_admin_email@example.com">
    </div>
    <div>
        <label for="adminPassword">Admin Password:</label>
        <input type="password" id="adminPassword">
    </div>
    <div>
        <label for="schemaJson">Schema JSON (pb_schema.json content):</label>
        <textarea id="schemaJson" rows="10"></textarea>
    </div>
     <div>
        <label for="seedDataJson">Seed Data for 'planner_templates' (JSON array with template objects):</label>
        <textarea id="seedDataJson" rows="15"></textarea>
    </div>

    <button id="setupButton">Run Full Setup</button>

    <h2>Log:</h2>
    <pre id="logOutput"></pre>

<script>
let uniqueIdCounter = 0;
const generateId = (prefix = 'id') => `${prefix}_${Date.now()}_${uniqueIdCounter++}_${Math.random().toString(36).substr(2, 5)}`;

const ensureIdsInArray = (items = [], idField = 'id') => items.map(item => {
    const newItem = { ...item }; // Create a shallow copy to avoid modifying original seed objects
    if (!newItem[idField]) {
        newItem[idField] = generateId(idField.replace('_id','')); // Simple prefix based on idField name
    }
    return newItem;
});

const ensureDeepIdsInSchedule = (schedule = []) => schedule.map(section => {
    const newSection = { ...section };
    if (!newSection.id) newSection.id = generateId('sec');
    newSection.activities = ensureIdsInArray(newSection.activities || [], 'id');
    return newSection;
});

const ensureDeepIdsInWorkout = (workoutPlan = []) => workoutPlan.map(day => {
    const newDay = { ...day };
    if (!newDay.id) newDay.id = generateId('wday');
    newDay.exercises = ensureIdsInArray(newDay.exercises || [], 'id');
    return newDay;
});


const defaultSchema = [
  {
    "name": "planners", "type": "base", "system": false,
    "listRule": null, "viewRule": null, "createRule": "", "updateRule": "", "deleteRule": "", "options": {},
    "fields": [
      {"name": "week_id", "type": "text", "required": true, "unique": true, "presentable": true, "options": {}},
      {"name": "dateRange", "type": "text", "required": false, "options": {}},
      {"name": "city", "type": "text", "required": false, "options": {}},
      {"name": "plannerTitle", "type": "text", "required": false, "presentable": true, "options": {}},
      {"name": "uiConfig", "type": "json", "required": false, "options": {"maxSize": 5242880}},
      {"name": "times", "type": "json", "required": false, "options": {"maxSize": 5242880}},
      {"name": "schedule", "type": "json", "required": false, "options": {"maxSize": 5242880}},
      {"name": "tasks", "type": "json", "required": false, "options": {"maxSize": 5242880}},
      {"name": "workoutPlan", "type": "json", "required": false, "options": {"maxSize": 5242880}},
      {"name": "meals", "type": "json", "required": false, "options": {"maxSize": 5242880}},
      {"name": "groceryBudget", "type": "text", "required": false, "options": {}},
      {"name": "groceryList", "type": "json", "required": false, "options": {"maxSize": 5242880}},
      {"name": "bodyMeasurements", "type": "json", "required": false, "options": {"maxSize": 5242880}},
      {"name": "financials", "type": "json", "required": false, "options": {"maxSize": 5242880}},
      {"name": "template_name_used", "type": "text", "required": false, "options": {}}
    ]
  },
  {
    "name": "planner_templates", "type": "base", "system": false,
    "listRule": null, "viewRule": null, "createRule": "", "updateRule": "", "deleteRule": "", "options": {},
    "fields": [
      {"name": "template_name", "type": "text", "required": true, "unique": true, "presentable": true, "options": {"pattern": "^[a-zA-Z0-9_\\-]+$"}},
      {"name": "description", "type": "text", "required": false, "options": {}},
      {"name": "is_default", "type": "bool", "required": false, "options": {}},
      {"name": "version", "type": "number", "required": false, "options": {"min":1}},
      {"name": "plannerTitle_default", "type": "text", "required": false, "options": {}},
      {"name": "uiConfig_structure", "type": "json", "required": true, "options": {"maxSize": 5242880}},
      {"name": "times_structure", "type": "json", "required": true, "options": {"maxSize": 5242880}},
      {"name": "schedule_structure", "type": "json", "required": true, "options": {"maxSize": 5242880}},
      {"name": "tasks_structure", "type": "json", "required": true, "options": {"maxSize": 5242880}},
      {"name": "workoutPlan_structure", "type": "json", "required": true, "options": {"maxSize": 5242880}},
      {"name": "meals_structure", "type": "json", "required": true, "options": {"maxSize": 5242880}},
      {"name": "groceryBudget_default", "type": "text", "required": false, "options": {}},
      {"name": "groceryList_structure", "type": "json", "required": true, "options": {"maxSize": 5242880}},
      {"name": "bodyMeasurements_structure", "type": "json", "required": true, "options": {"maxSize": 5242880}},
      {"name": "financials_structure", "type": "json", "required": true, "options": {"maxSize": 5242880}},
      {"name": "city_default", "type": "text", "required": false, "options": {}}
    ]
  }
];

const defaultTemplateSeedData = [
    {
        template_name: "standard-weekly-v1",
        description: "Standard weekly planner template, version 1.",
        is_default: true,
        version: 1,
        plannerTitle_default: "My Weekly Plan",
        uiConfig_structure: {
            mainTableHeaders: ['TIME', 'DAY', 'ACTIVITY', 'SCR', 'MAX', 'üî•'],
            dayHeaders: ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'],
            maxHeaders: Array(7).fill('MAX'),
            taskHeaders: ['‚Ññ', 'üî•', 'üè∑Ô∏è', '‚úèÔ∏è Task/Event/Note', 'üìÖ', '‚úì'],
            sectionTitles: { tasks: 'TASKS & NOTES', workout: 'WORKOUT PLAN', meals: 'MEAL PREP', grocery: 'GROCERY LIST', measurements: 'BODY MEASUREMENTS', financials: 'MONTH/1ST: FINANCIAL' }
        },
        times_structure: [ { label: 'Q', value: '' }, { label: 'F', value: '' }, { label: 'D', value: '' }, { label: 'A', value: '' }, { label: 'M', value: '' }, { label: 'I', value: '' } ],
        schedule_structure: [ // IDs will be added by ensureDeepIdsInSchedule
          { name: 'QIYAM', activities: [
              { name: 'DAILY: Wakeup early', days: { mon: {value:'',max:1}, tue: {value:'',max:1}, wed: {value:'',max:1}, thu: {value:'',max:1}, fri: {value:'',max:1}, sat: {value:'',max:1}, sun: {value:'',max:1} }, score:0, maxScore:7, streaks:{current:0,longest:0}},
              { name: 'DAILY: Qiyam/Tahajjud', days: { mon: {value:'',max:1}, tue: {value:'',max:1}, wed: {value:'',max:1}, thu: {value:'',max:1}, fri: {value:'',max:1}, sat: {value:'',max:1}, sun: {value:'',max:1} }, score:0, maxScore:7, streaks:{current:0,longest:0}},
              { name: 'DAILY: Nutty Pudding', days: { mon: {value:'',max:1}, tue: {value:'',max:1}, wed: {value:'',max:1}, thu: {value:'',max:1}, fri: {value:'',max:1}, sat: {value:'',max:1}, sun: {value:'',max:1} }, score:0, maxScore:7, streaks:{current:0,longest:0}}
          ]},
          { name: 'FAJR', activities: [
              { name: 'DAILY: Fajr prayer', days: { mon: {value:'',max:1}, tue: {value:'',max:1}, wed: {value:'',max:1}, thu: {value:'',max:1}, fri: {value:'',max:1}, sat: {value:'',max:1}, sun: {value:'',max:1} }, score:0, maxScore:7, streaks:{current:0,longest:0}},
              { name: 'DAILY: Quran - 1 Juz', days: { mon: {value:'',max:1}, tue: {value:'',max:1}, wed: {value:'',max:1}, thu: {value:'',max:1}, fri: {value:'',max:1}, sat: {value:'',max:1}, sun: {value:'',max:1} }, score:0, maxScore:7, streaks:{current:0,longest:0}},
              { name: 'DAILY: 5min Cold Shower', days: { mon: {value:'',max:1}, tue: {value:'',max:1}, wed: {value:'',max:1}, thu: {value:'',max:1}, fri: {value:'',max:1}, sat: {value:'',max:1}, sun: {value:'',max:1} }, score:0, maxScore:7, streaks:{current:0,longest:0}}
          ]},
          { name: '7AM - 9AM', activities: [
              { name: 'MON/THU: COMMUTE', days: { mon: {value:'',max:1}, thu: {value:'',max:1} }, score:0, maxScore:2, streaks:{current:0,longest:0}},
              { name: 'TUE/WED/FRI: Reading/Study (book/course/skill)', days: { tue: {value:'',max:1}, wed: {value:'',max:1}, fri: {value:'',max:1} }, score:0, maxScore:3, streaks:{current:0,longest:0}},
              { name: 'SAT: Errands, Grocery shopping, Meal prep', days: { sat: {value:'',max:3} }, score:0, maxScore:3, streaks:{current:0,longest:0}},
              { name: 'SUN: House cleaning, laundry', days: { sun: {value:'',max:2} }, score:0, maxScore:2, streaks:{current:0,longest:0}}
          ]},
          { name: '9AM - 5PM', activities: [
              { name: 'MON - FRI: Work', days: { mon: {value:'',max:1}, tue: {value:'',max:1}, wed: {value:'',max:1}, thu: {value:'',max:1}, fri: {value:'',max:1} }, score:0, maxScore:5, streaks:{current:0,longest:0}},
              { name: 'DAILY: ZeroInbox (E1, E2, E3, E4, LI, Slack)', days: { mon: {value:'',max:6}, tue: {value:'',max:6}, wed: {value:'',max:6}, thu: {value:'',max:6}, fri: {value:'',max:6} }, score:0, maxScore:30, streaks:{current:0,longest:0}},
              { name: 'SAT/SUN: Nature time / Outdoor Activity / Adventure', days: { sat: {value:'',max:1}, sun: {value:'',max:1} }, score:0, maxScore:2, streaks:{current:0,longest:0}}
          ]},
          { name: 'DHUHR', activities: [
              { name: 'DAILY: Dhuhr prayer', days: { mon: {value:'',max:1}, tue: {value:'',max:1}, wed: {value:'',max:1}, thu: {value:'',max:1}, fri: {value:'',max:1}, sat: {value:'',max:1}, sun: {value:'',max:1} }, score:0, maxScore:7, streaks:{current:0,longest:0}},
              { name: 'TUE/WED/FRI: Sun walk (30-45 minutes)', days: { tue: {value:'',max:1}, wed: {value:'',max:1}, fri: {value:'',max:1} }, score:0, maxScore:3, streaks:{current:0,longest:0}},
              { name: 'FRI: ¬£10 Sadaqa', days: { fri: {value:'',max:1} }, score:0, maxScore:1, streaks:{current:0,longest:0}}
          ]},
          { name: 'ASR', activities: [ { name: 'DAILY: Asr prayer', days: { mon: {value:'',max:1}, tue: {value:'',max:1}, wed: {value:'',max:1}, thu: {value:'',max:1}, fri: {value:'',max:1}, sat: {value:'',max:1}, sun: {value:'',max:1} }, score:0, maxScore:7, streaks:{current:0,longest:0}} ]},
          { name: '5PM - 6:30PM', activities: [
              { name: 'MON/THU: COMMUTE', days: { mon: {value:'',max:1}, thu: {value:'',max:1} }, score:0, maxScore:2, streaks:{current:0,longest:0}},
              { name: 'TUE/WED/FRI: Workout', days: { tue: {value:'',max:1}, wed: {value:'',max:1}, fri: {value:'',max:1} }, score:0, maxScore:3, streaks:{current:0,longest:0}},
              { name: 'TUE/WED/FRI: Third Meal', days: { tue: {value:'',max:1}, wed: {value:'',max:1}, fri: {value:'',max:1} }, score:0, maxScore:3, streaks:{current:0,longest:0}}
          ]},
          { name: '6:30PM - ISHA', activities: [
              { name: 'MON/TUE/WED/THU: Personal', days: { mon: {value:'',max:1}, tue: {value:'',max:1}, wed: {value:'',max:1}, thu: {value:'',max:1} }, score:0, maxScore:4, streaks:{current:0,longest:0}},
              { name: 'DAILY: Family/Friends/Date calls(M, WA, Phone)', days: { mon: {value:'',max:3}, tue: {value:'',max:3}, wed: {value:'',max:3}, thu: {value:'',max:3} }, score:0, maxScore:12, streaks:{current:0,longest:0}},
              { name: 'FRI/SAT/SUN: Family/Friends/Date visits/outings/activities', days: { fri: {value:'',max:3}, sat: {value:'',max:3}, sun: {value:'',max:3} }, score:0, maxScore:9, streaks:{current:0,longest:0}}
          ]},
          { name: 'MAGHRIB', activities: [
              { name: 'DAILY: Maghrib prayer', days: { mon: {value:'',max:1}, tue: {value:'',max:1}, wed: {value:'',max:1}, thu: {value:'',max:1}, fri: {value:'',max:1}, sat: {value:'',max:1}, sun: {value:'',max:1} }, score:0, maxScore:7, streaks:{current:0,longest:0}},
              { name: 'DAILY: Super Veggie', days: { mon: {value:'',max:1}, tue: {value:'',max:1}, wed: {value:'',max:1}, thu: {value:'',max:1}, fri: {value:'',max:1}, sat: {value:'',max:1}, sun: {value:'',max:1} }, score:0, maxScore:7, streaks:{current:0,longest:0}}
          ]},
          { name: 'ISHA', activities: [
              { name: 'DAILY: Isha prayer', days: { mon: {value:'',max:1}, tue: {value:'',max:1}, wed: {value:'',max:1}, thu: {value:'',max:1}, fri: {value:'',max:1}, sat: {value:'',max:1}, sun: {value:'',max:1} }, score:0, maxScore:7, streaks:{current:0,longest:0}},
              { name: 'DAILY: Sleep early', days: { mon: {value:'',max:1}, tue: {value:'',max:1}, wed: {value:'',max:1}, thu: {value:'',max:1}, fri: {value:'',max:1}, sat: {value:'',max:1}, sun: {value:'',max:1} }, score:0, maxScore:7, streaks:{current:0,longest:0}}
          ]},
          { name: 'ALLDAY', activities: [
              { name: 'DAILY: No Doomscrolling; (FB, YTB, LKDN, & IG)', days: { mon: {value:'',max:4}, tue: {value:'',max:4}, wed: {value:'',max:4}, thu: {value:'',max:4}, fri: {value:'',max:4}, sat: {value:'',max:4}, sun: {value:'',max:4} }, score:0, maxScore:28, streaks:{current:0,longest:0}},
              { name: 'DAILY: No Fap; (P, & M)', days: { mon: {value:'',max:2}, tue: {value:'',max:2}, wed: {value:'',max:2}, thu: {value:'',max:2}, fri: {value:'',max:2}, sat: {value:'',max:2}, sun: {value:'',max:2} }, score:0, maxScore:14, streaks:{current:0,longest:0}},
              { name: 'DAILY: No Processed; (Sugar, RefinedFlour, SeedOils, Soda, FastFood)', days: { mon: {value:'',max:5}, tue: {value:'',max:5}, wed: {value:'',max:5}, thu: {value:'',max:5}, fri: {value:'',max:5}, sat: {value:'',max:5}, sun: {value:'',max:5} }, score:0, maxScore:35, streaks:{current:0,longest:0}},
              { name: 'MON/THU: Fasting', days: { mon: {value:'',max:1}, thu: {value:'',max:1} }, score:0, maxScore:2, streaks:{current:0,longest:0}},
              { name: 'DAILY: Expense Tracker <25', days: { mon: {value:'',max:0}, tue: {value:'',max:0}, wed: {value:'',max:0}, thu: {value:'',max:0}, fri: {value:'',max:0}, sat: {value:'',max:0}, sun: {value:'',max:0} }, score:0, maxScore:0, streaks:{current:0,longest:0}}
          ]},
          { name: 'TOTAL', activities: [
              { name: 'DAILY POINTS', days: { mon: {value:'0',max:0}, tue: {value:'0',max:0}, wed: {value:'0',max:0}, thu: {value:'0',max:0}, fri: {value:'0',max:0}, sat: {value:'0',max:0}, sun: {value:'0',max:0} }, score:0, maxScore:0, streaks:{current:0,longest:0}}
          ]}
        ],
        tasks_structure: { count: 20, defaultFields: { num: '', priority: '', tag: '', description: '', date: '', completed: '' }},
        workoutPlan_structure: [ // IDs will be added by ensureDeepIdsInWorkout
            { name: 'TUESDAY', exercises: [
                { prefix: '‚Ä¢ ', name: 'Incline Dumbbell Press', weight: '', sets: '', reps: '', defaultWeight: '30', defaultSets: '3', defaultReps: '12' },
                { prefix: '‚Ä¢ ', name: 'Barbell Squats', weight: '', sets: '', reps: '', defaultWeight: '80', defaultSets: '3', defaultReps: '8' },
                { prefix: '‚Ä¢ ', name: 'DB Chest-Supported Row', weight: '', sets: '', reps: '', defaultWeight: '25', defaultSets: '3', defaultReps: '12' },
                { prefix: '‚Ä¢ ', name: 'Leg Curls', weight: '', sets: '', reps: '', defaultWeight: '40', defaultSets: '3', defaultReps: '15' },
                { prefix: '‚Ä¢ SS: ', name: 'Incline DB Curls', weight: '', sets: '', reps: '', defaultWeight: '15', defaultSets: '3', defaultReps: '12' },
                { prefix: '‚Ä¢ SS: ', name: 'Tricep Extensions', weight: '', sets: '', reps: '', defaultWeight: '20', defaultSets: '3', defaultReps: '12' }
            ]},
            { name: 'WEDNESDAY', exercises: [
                { prefix: '‚Ä¢ ', name: 'Barbell Bench Press', weight: '', sets: '', reps: '', defaultWeight: '70', defaultSets: '3', defaultReps: '6' },
                { prefix: '‚Ä¢ ', name: 'Romanian Deadlift', weight: '', sets: '', reps: '', defaultWeight: '90', defaultSets: '3', defaultReps: '8' },
                { prefix: '‚Ä¢ ', name: 'Lat Pulldown', weight: '', sets: '', reps: '', defaultWeight: '60', defaultSets: '3', defaultReps: '12' },
                { prefix: '‚Ä¢ ', name: 'Walking Lunges', weight: '', sets: '', reps: '', defaultWeight: '20', defaultSets: '3', defaultReps: '10' },
                { prefix: '‚Ä¢ SS: ', name: 'Cable Lateral Raises', weight: '', sets: '', reps: '', defaultWeight: '15', defaultSets: '3', defaultReps: '15' },
                { prefix: '‚Ä¢ SS: ', name: 'Reverse Crunches', weight: '', sets: '', reps: '', defaultWeight: '0', defaultSets: '3', defaultReps: '15' }
            ]},
            { name: 'FRIDAY', exercises: [
                { prefix: '‚Ä¢ ', name: 'Seated DB Shoulder Press', weight: '', sets: '', reps: '', defaultWeight: '20', defaultSets: '3', defaultReps: '12' },
                { prefix: '‚Ä¢ ', name: 'Dumbbell Row', weight: '', sets: '', reps: '', defaultWeight: '25', defaultSets: '3', defaultReps: '12' },
                { prefix: '‚Ä¢ ', name: 'Barbell Hip Thrust', weight: '', sets: '', reps: '', defaultWeight: '100', defaultSets: '3', defaultReps: '15' },
                { prefix: '‚Ä¢ ', name: 'Leg Extensions', weight: '', sets: '', reps: '', defaultWeight: '50', defaultSets: '3', defaultReps: '15' },
                { prefix: '‚Ä¢ ', name: 'Seated Chest Flyes', weight: '', sets: '', reps: '', defaultWeight: '15', defaultSets: '3', defaultReps: '15' },
                { prefix: '‚Ä¢ SS: ', name: 'Standing Calf Raises', weight: '', sets: '', reps: '', defaultWeight: '30', defaultSets: '3', defaultReps: '15' },
                { prefix: '‚Ä¢ SS: ', name: 'Reverse Cable Flyes', weight: '', sets: '', reps: '', defaultWeight: '20', defaultSets: '3', defaultReps: '15' }
            ]}
        ],
        meals_structure: [ // IDs will be added by ensureIdsInArray
            { name: 'Nutty Pudding', ingredients: 'Berries ¬Ωc, Cherries 3, Pomegranate Juice 2oz, Macadamia nuts (raw) 45g, Walnuts (raw) 5g, Cocoa 1t, Brazil Nuts ¬º, Milk 50-100ml, Chia Seeds 2T, Flax (ground, refr) 1t, Lecithin 1t, Ceylon Cinnamon ¬Ωt' },
            { name: 'Super Veggie', ingredients: 'Broccoli 250g, Cauliflower 150g, Mushrooms 50g, Garlic 1 clove, Ginger 3g, Cumin 1T, Black Lentils 45g, Hemp Seeds 1T, Apple Cider Vinegar 1T' },
            { name: 'Third Meal', ingredients: 'Sweet Potato 350-400g, Protein 100-150g, Grape Tomatoes 12, Avocado ¬Ω, Radishes 4, Cilantro ¬ºc, Lemon 1, Jalape√±o (lg) 1, Chili Powder 1t' }
        ],
        groceryBudget_default: '120',
        groceryList_structure: [ // IDs will be added by ensureIdsInArray
            { name: 'Produce', items: 'Broccoli 1.75kg, Cauliflower 1.05kg, Mushrooms 350g, Garlic 1 bulb, Ginger 1pc, Sweet Potato 2.8kg, Grape Tomatoes 84, Avocados (ripe) 4, Radishes 28, Cilantro 2-3 bunch' },
            { name: 'Fruits & Protein', items: 'Lemons 7, Jalape√±os (lg) 7, Berries 3.5c, Cherries 21, Black Lentils 315g, Protein 1.05kg, Milk (fortified) 1L' }
        ],
        bodyMeasurements_structure: [ // IDs will be added by ensureIdsInArray
            { name: 'Weight', placeholder: '75kg' }, { name: 'Chest', placeholder: '42in' },
            { name: 'Waist', placeholder: '34in' }, { name: 'Hips', placeholder: '40in' },
            { name: 'Arms', placeholder: '15in' }, { name: 'Thighs', placeholder: '24in' }
        ],
        financials_structure: [ // IDs will be added by ensureIdsInArray
            { name: 'Rent', placeholder: '850', account: 'Cash' },
            { name: 'Allowance', placeholder: '850', account: 'Revolut' },
            { name: 'Savings', placeholder: '3,800', account: 'HSBCUK' }
        ],
        city_default: "London"
    }
];


const schemaInput = document.getElementById('schemaJson');
const seedDataInput = document.getElementById('seedDataJson');
const pbUrlInput = document.getElementById('pbUrl');
const adminEmailInput = document.getElementById('adminEmail');
const adminPasswordInput = document.getElementById('adminPassword');
const setupButton = document.getElementById('setupButton');
const logOutput = document.getElementById('logOutput');

schemaInput.value = JSON.stringify(defaultSchema, null, 2);

const processedSeedData = defaultTemplateSeedData.map(template => {
    // Create a deep copy to avoid modifying the original defaultTemplateSeedData object
    const newTemplate = JSON.parse(JSON.stringify(template));
    newTemplate.schedule_structure = ensureDeepIdsInSchedule(newTemplate.schedule_structure);
    newTemplate.workoutPlan_structure = ensureDeepIdsInWorkout(newTemplate.workoutPlan_structure);
    newTemplate.meals_structure = ensureIdsInArray(newTemplate.meals_structure, 'id');
    newTemplate.groceryList_structure = ensureIdsInArray(newTemplate.groceryList_structure, 'id');
    newTemplate.bodyMeasurements_structure = ensureIdsInArray(newTemplate.bodyMeasurements_structure, 'id');
    newTemplate.financials_structure = ensureIdsInArray(newTemplate.financials_structure, 'id');
    // tasks_structure is an object, not an array of items needing top-level IDs here.
    // If tasks_structure.defaultFields was an array of objects, that would need ensureIdsInArray.
    return newTemplate;
});
seedDataInput.value = JSON.stringify(processedSeedData, null, 2);


function logMessage(message, type = 'info') {
    const p = document.createElement('p');
    p.textContent = message;
    if (type === 'error') p.classList.add('error');
    if (type === 'success') p.classList.add('success');
    if (type === 'warning') p.classList.add('warning');
    logOutput.appendChild(p);
    logOutput.scrollTop = logOutput.scrollHeight;
}

setupButton.addEventListener('click', async () => {
    logOutput.innerHTML = '';
    const pbUrl = pbUrlInput.value.trim();
    const adminEmail = adminEmailInput.value.trim();
    const adminPassword = adminPasswordInput.value;
    let schemaToCreate, seedDataForTemplates;

    if (!pbUrl || !adminEmail || !adminPassword) {
        logMessage('PocketBase URL, Admin Email, and Admin Password are required.', 'error');
        return;
    }

    try {
        schemaToCreate = JSON.parse(schemaInput.value);
        if (!Array.isArray(schemaToCreate)) throw new Error('Schema JSON must be an array.');
    } catch (e) { logMessage('Error parsing Schema JSON: ' + e.message, 'error'); return; }

    try {
        seedDataForTemplates = JSON.parse(seedDataInput.value);
        if (!Array.isArray(seedDataForTemplates)) throw new Error('Seed Data JSON must be an array of template objects.');
    } catch (e) { logMessage('Error parsing Seed Data JSON: ' + e.message, 'error'); return; }


    const pb = new PocketBase(pbUrl);

    try {
        logMessage(`Attempting to authenticate admin ${adminEmail}...`);
        await pb.admins.authWithPassword(adminEmail, adminPassword);
        logMessage('Admin authentication successful.', 'success');

        logMessage('\n--- Starting Collection Creation/Update ---', 'info');
        for (const collectionDef of schemaToCreate) {
            logMessage(`Processing collection: ${collectionDef.name}`);
            const collectionPayload = {
                name: collectionDef.name, type: collectionDef.type || 'base',
                system: collectionDef.system || false,
                listRule: collectionDef.listRule !== undefined ? collectionDef.listRule : null,
                viewRule: collectionDef.viewRule !== undefined ? collectionDef.viewRule : null,
                createRule: collectionDef.createRule !== undefined ? collectionDef.createRule : "",
                updateRule: collectionDef.updateRule !== undefined ? collectionDef.updateRule : "",
                deleteRule: collectionDef.deleteRule !== undefined ? collectionDef.deleteRule : "",
                options: collectionDef.options || {}, fields: [], indexes: []
            };

            if (collectionDef.fields && Array.isArray(collectionDef.fields)) {
                collectionPayload.fields = collectionDef.fields.map(f => ({ name: f.name, type: f.type, required: f.required || false, options: f.options || {} }));
                collectionDef.fields.forEach(f => { if (f.unique) collectionPayload.indexes.push(`CREATE UNIQUE INDEX idx_unique_${collectionDef.name.replace(/\W/g, '_')}_${f.name.replace(/\W/g, '_')} ON {{${collectionDef.name}}} (${f.name})`); });
                if(collectionPayload.indexes.length === 0) delete collectionPayload.indexes;
            }

            if (collectionDef.type === 'view') {
                if (!collectionDef.viewQuery) { logMessage(`Error: viewQuery required for ${collectionDef.name}. Skipping.`, 'error'); continue; }
                collectionPayload.viewQuery = collectionDef.viewQuery; delete collectionPayload.fields; delete collectionPayload.indexes;
            }
            try {
                let existingCollection = null;
                try { existingCollection = await pb.collections.getOne(collectionDef.name); } catch (e) { /* Not found, will create */ }

                if (existingCollection) {
                    logMessage(`Collection "${collectionDef.name}" exists. Attempting to update (rules, options, non-index fields).`, 'warning');
                    const updatePayload = { ...collectionPayload };
                    delete updatePayload.name; delete updatePayload.type; delete updatePayload.indexes;
                    if (updatePayload.fields) { updatePayload.fields = updatePayload.fields.filter(f => !f.system); }
                    const updated = await pb.collections.update(existingCollection.id, updatePayload);
                    logMessage(`Collection "${updated.name}" updated.`, 'success');
                } else {
                    const created = await pb.collections.create(collectionPayload);
                    logMessage(`Collection "${created.name}" (ID: ${created.id}) created.`, 'success');
                }
            } catch (e) {
                logMessage(`Error processing collection "${collectionDef.name}": ${e.message}.`, 'error');
                if (e.data && e.data.data) logMessage(JSON.stringify(e.data.data, null, 2), 'error');
            }
        }
        logMessage('--- Collection Creation/Update Finished ---', 'info');

        logMessage('\n--- Starting Data Seeding for planner_templates ---', 'info');
        const templatesCollectionName = 'planner_templates';
        for (const templateDoc of seedDataForTemplates) {
            if (!templateDoc.template_name) {
                logMessage('Skipping seed item without template_name.', 'warning');
                continue;
            }
            logMessage(`Processing seed for template: ${templateDoc.template_name}`);
            try {
                await pb.collection(templatesCollectionName).getFirstListItem(`template_name="${templateDoc.template_name}"`);
                logMessage(`Template "${templateDoc.template_name}" already exists. Skipping creation.`, 'warning');
            } catch (e) {
                if (e.status === 404) {
                    try {
                        // IDs should have been processed when seedDataInput.value was set by `processedSeedData`
                        await pb.collection(templatesCollectionName).create(templateDoc);
                        logMessage(`Template "${templateDoc.template_name}" seeded successfully.`, 'success');
                    } catch (createError) {
                        logMessage(`Error seeding template "${templateDoc.template_name}": ${createError.message}`, 'error');
                        if (createError.data && createError.data.data) logMessage(JSON.stringify(createError.data.data, null, 2), 'error');
                    }
                } else {
                    logMessage(`Error checking for existing template "${templateDoc.template_name}": ${e.message}`, 'error');
                }
            }
        }
        logMessage('--- Data Seeding Finished ---', 'info');
        logMessage('\nFull setup process finished.', 'info');

    } catch (e) {
        logMessage('A major error occurred: ' + e.toString(), 'error');
        if (e.data && e.data.data) logMessage(JSON.stringify(e.data.data, null, 2), 'error');
    } finally {
        pb.authStore.clear();
        logMessage('Admin session cleared.', 'info');
    }
});
</script>
</body>
</html>
