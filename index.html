<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=210mm, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>A4 Planner</title>
  <script src="pocketbase.umd.js"></script>
  <script defer src="script.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.9/dist/cdn.min.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body x-data="plannerApp()" x-init="init()">
  <div class="offline-warning" :class="{ 'show': !isOnline }">
    ⚠️ Offline Mode - Changes saved locally only. Will sync when connection restored.
  </div>

  <div id="save-status" :class="'status-' + saveStatus" x-text="saveStatus === 'saving' ? 'Saving...' : (saveStatus === 'error' ? 'Error!' : saveStatus === 'local' ? 'Local' : saveStatus === 'syncing' ? 'Syncing...' : 'Saved')"></div>
  <div id="sync-status" :class="isOnline ? 'status-online' : 'status-offline'" x-show="!isOnline || syncQueue.length > 0">
    <span x-text="isOnline ? (syncQueue.length > 0 ? `Queue: ${syncQueue.length}` : 'Online') : 'Offline'"></span>
  </div>
  <div id="offline-status" x-show="hasUnsavedLocalChanges" class="status-local">
    Unsaved Changes
  </div>
  <div id="notification" :class="{ 'show': showNotification }" x-text="notificationMessage"></div>

  <div class="card">
    <div class="flex between center mb-1">
      <h1 class="text-sm bold editable" @dblclick="editField($event, 'plannerTitle', plannerTitle)" x-text="plannerTitle"></h1>
      <div class="flex center text-xs">
        <template x-for="(time, i) in times" :key="i">
          <div class="flex center">
            <span class="editable" @dblclick="editField($event, 'timeLabel', time.label, i)" x-text="time.label + ':'"></span>
            <input type="text" class="mini-input time-value-input" x-model="time.value" @change="saveData()">
          </div>
        </template>
        <span class="ml-1">|</span>
        <span class="clickable ml-1" x-text="city" @click="toggleSelector($event, 'city')"></span>
      </div>
      <div class="text-sm">
        <span class="clickable" x-text="currentWeek" @click="toggleSelector($event, 'week')"></span> (<span x-text="dateRange"></span>)
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th class="editable main-col-1" @dblclick="editField($event, 'header', uiConfig.mainTableHeaders?.[0], 'main', 0)" x-text="uiConfig.mainTableHeaders?.[0]"></th>
          <th class="editable main-col-2" @dblclick="editField($event, 'header', uiConfig.mainTableHeaders?.[1], 'main', 1)" x-text="uiConfig.mainTableHeaders?.[1]"></th>
          <th class="ac editable" @dblclick="editField($event, 'header', uiConfig.mainTableHeaders?.[2], 'main', 2)" x-text="uiConfig.mainTableHeaders?.[2]"></th>
          <template x-for="(dayKey, i) in ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN']" :key="dayKey">
            <th class="dc editable" :class="{'current-day': i === (currentDay || 7) - 1}" @dblclick="editField($event, 'header', uiConfig.dayHeaders?.[i], 'day', i)" x-text="uiConfig.dayHeaders?.[i]"></th>
            <th class="dc editable" :class="{'current-day': i === (currentDay || 7) - 1}" @dblclick="editField($event, 'header', uiConfig.maxHeaders?.[i], 'max', i)" x-text="uiConfig.maxHeaders?.[i]"></th>
          </template>
          <th class="dc editable" @dblclick="editField($event, 'header', uiConfig.mainTableHeaders?.[3], 'main', 3)" x-text="uiConfig.mainTableHeaders?.[3]"></th>
          <th class="dc editable" @dblclick="editField($event, 'header', uiConfig.mainTableHeaders?.[4], 'main', 4)" x-text="uiConfig.mainTableHeaders?.[4]"></th>
          <th class="dc editable" @dblclick="editField($event, 'header', uiConfig.mainTableHeaders?.[5], 'main', 5)" x-text="uiConfig.mainTableHeaders?.[5]"></th>
        </tr>
      </thead>
      <tbody>
        <template x-for="(section, sIdx) in schedule.slice().reverse()" :key="section.id">
          <template x-for="(activity, aIdx) in section.activities" :key="activity.id">
            <tr :class="{'total': section.name === 'TOTAL'}">
              <td class="bold editable" @dblclick="editField($event, 'sectionName', section.name, sIdx)" x-text="aIdx === 0 ? section.name : ''"></td>
              <td class="bold editable" @dblclick="editField($event, 'activityPrefix', activity.name.split(':')[0].trim(), {sIdx, aIdx})" x-text="activity.name.includes(':') ? activity.name.split(':')[0] : ''"></td>
              <td class="ac editable" @dblclick="editField($event, 'activityName', activity.name.includes(':') ? activity.name.split(':')[1].trim() : activity.name, {sIdx, aIdx})">
                <span x-text="activity.name.includes(':') ? activity.name.split(':')[1].trim() : activity.name"></span>
              </td>
              <template x-for="(day, i) in ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun']" :key="day">
                <td class="dc" :class="{'current-day': i === (currentDay || 7) - 1}">
                  <template x-if="activity.days && activity.days[day]">
                    <input type="number" class="mini-input" x-model.number="activity.days[day].value" :min="0" :max="activity.days[day].max < 10 ? 9 : 99" @input="validateAndSave($event)" :readonly="section.name === 'TOTAL'">
                  </template>
                </td>
                <td class="dc editable" :class="{'current-day': i === (currentDay || 7) - 1}" @dblclick="editField($event, 'maxValue', activity.days?.[day]?.max || '', {sIdx, aIdx, day})" x-text="activity.days?.[day]?.max || ''"></td>
              </template>
              <td class="dc" :class="getScoreClass(activity)">
                <input type="number" class="mini-input" x-model.number="activity.score" readonly>
              </td>
              <td class="dc editable" @dblclick="editField($event, 'maxScore', activity.maxScore, {sIdx, aIdx})" x-text="activity.maxScore"></td>
              <td class="dc streak-cell" :class="{'has-streak': activity.streaks?.current > 2}">
                <span x-text="activity.streaks?.current > 0 ? activity.streaks.current : ''"></span>
              </td>
            </tr>
          </template>
          <tr x-if="section.name === 'TOTAL' && section.activities?.length > 0 && section.activities[0].maxScore > 0">
            <td colspan="19" class="progress-container">
              <div class="progress-bar" :style="getProgressStyle(section.activities[0])" :class="getProgressClass(section.activities[0])"></div>
            </td>
          </tr>
        </template>
      </tbody>
    </table>

    <div class="section">
      <h3 class="section-title editable" @dblclick="editField($event, 'sectionTitle', uiConfig.sectionTitles?.tasks, 'tasks')" x-text="uiConfig.sectionTitles?.tasks"></h3>
      <table class="task-table">
        <colgroup>
          <col style="width: 6mm;">
          <col style="width: 6mm;">
          <col style="width: 4mm;">
          <col style="width: 150mm;">
          <col style="width: 8mm;">
          <col style="width: 8mm;">
          <col style="width: 8mm;">
          <col style="width: 6mm;">
          <col style="width: 4mm;">
        </colgroup>
        <thead>
          <tr>
            <template x-for="(header, i) in uiConfig.taskHeaders" :key="i">
              <th class="editable" @dblclick="editField($event, 'header', header, 'task', i)" x-text="header"></th>
            </template>
          </tr>
        </thead>
        <tbody>
          <template x-for="(task, i) in tasks" :key="task.id || i">
            <tr :class="getTaskRowClass(task)" class="task-row">
              <td><input type="text" class="mini-input" x-model="task.num" :placeholder="uiHints.placeholders?.task_num_prefix ? uiHints.placeholders.task_num_prefix + (i + 1) : (i + 1)" @change="saveData()"></td>
              <td><input type="text" class="mini-input" x-model="task.priority" :placeholder="uiHints.placeholders?.task_priority" @change="saveData()"></td>
              <td><input type="text" class="mini-input" x-model="task.tag" :placeholder="uiHints.placeholders?.task_tag" @change="saveData()"></td>
              <td><input type="text" class="mini-input task-description-input" x-model="task.description" :placeholder="uiHints.placeholders?.task_description" @change="saveData()"></td>
              <td><input type="date" class="mini-input date-input" x-model="task.startDate" @change="calculateTaskDelay(task); saveData();"></td>
              <td><input type="date" class="mini-input date-input" x-model="task.expectedDate" @change="calculateTaskDelay(task); saveData();"></td>
              <td><input type="date" class="mini-input date-input" x-model="task.actualDate" @change="calculateTaskDelay(task); saveData();"></td>
              <td class="dc delay-cell" :class="getDelayClass(task)">
                <span x-text="formatDelay(getTaskDelay(task))"></span>
              </td>
              <td><input type="text" class="mini-input" x-model="task.completed" @click.prevent="toggleTaskCompletion(task)" :class="{'completed-task': task.completed === uiHints.symbols?.task_checkbox_checked}" :placeholder="uiHints.symbols?.task_checkbox_empty"></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <div class="section">
      <h3 class="section-title editable" @dblclick="editField($event, 'sectionTitle', uiConfig.sectionTitles?.workout, 'workout')" x-text="uiConfig.sectionTitles?.workout"></h3>
      <div class="grid">
        <template x-for="(day, dayIdx) in workoutPlan" :key="day.id || dayIdx">
          <div class="p-1 workout-day-card">
            <p class="bold text-center mb-1 editable workout-day-name" @dblclick="editField($event, 'workoutDayName', day.name, dayIdx)" x-text="day.name"></p>
            <template x-for="(ex, exIdx) in day.exercises" :key="ex.id || exIdx">
              <div class="exercise">
                <div class="exercise-name editable" :title="ex.name" @dblclick="editField($event, 'exerciseName', ex.name, {dayIdx, exIdx})">
                  <span x-text="ex.name"></span>:
                </div>
                <div class="exercise-inputs">
                  <input type="number" class="mini-input" x-model.number="ex.weight" @input="saveData();" :placeholder="ex.defaultWeight || uiHints.placeholders?.workout_weight_value">
                  <span class="exercise-unit" x-text="uiHints.symbols?.weight_unit"></span>,
                  <input type="number" class="mini-input sets" x-model.number="ex.sets" @input="saveData();" :placeholder="ex.defaultSets || uiHints.placeholders?.workout_sets_value">
                  <span class="exercise-unit" x-text="uiHints.symbols?.sets_reps_separator"></span>
                  <input type="number" class="mini-input reps" x-model.number="ex.reps" @input="saveData();" :placeholder="ex.defaultReps || uiHints.placeholders?.workout_reps_value">
                </div>
              </div>
            </template>
          </div>
        </template>
      </div>
    </div>

    <div class="section">
      <h3 class="section-title editable" @dblclick="editField($event, 'sectionTitle', uiConfig.sectionTitles?.meals, 'meals')" x-text="uiConfig.sectionTitles?.meals"></h3>
      <ul class="list text-xs">
        <template x-for="(meal, i) in meals" :key="meal.id || i">
          <li class="list-item">
            <span class="bold editable" @dblclick="editField($event, 'mealName', meal.name, i)" x-text="meal.name + ':'"></span>
            <span class="editable" @dblclick="editField($event, 'mealIngredients', meal.ingredients, i)" x-text="meal.ingredients"></span>
          </li>
        </template>
      </ul>
    </div>

    <div class="section">
      <h3 class="section-title inline-title editable" @dblclick="editField($event, 'sectionTitle', uiConfig.sectionTitles?.grocery, 'grocery')">
        <span x-text="uiConfig.sectionTitles?.grocery"></span>
        <span x-text="uiHints.symbols?.currency_default"></span>
        <input type="text" class="mini-input inline-input" x-model="groceryBudget" :placeholder="uiHints.placeholders?.grocery_budget_value" @change="saveData();">
      </h3>
      <ul class="list text-xs">
        <template x-for="(cat, i) in groceryList" :key="cat.id || i">
          <li class="list-item">
            <span class="bold editable" @dblclick="editField($event, 'groceryCategoryName', cat.name, i)" x-text="cat.name + ':'"></span>
            <span class="editable" @dblclick="editField($event, 'groceryCategoryItems', cat.items, i)" x-text="cat.items"></span>
          </li>
        </template>
      </ul>
    </div>

    <div class="section">
      <h3 class="section-title inline-title editable" @dblclick="editField($event, 'sectionTitle', uiConfig.sectionTitles?.measurements, 'measurements')">
        <span x-text="uiConfig.sectionTitles?.measurements"></span>
        <template x-for="(m, i) in bodyMeasurements" :key="m.id || i">
          <span class="inline-measurement">
            <span class="editable measurement-label" @dblclick="editField($event, 'measurementName', m.name, i)" x-text="m.name + ':'"></span>
            <input type="text" class="mini-input inline-input" x-model="m.value" :placeholder="m.placeholder || uiHints.placeholders?.measurement_value" @change="saveData();">
            <span class="measurement-unit" x-text="m.unit || uiHints.symbols?.default_measurement_unit"></span>
          </span>
        </template>
      </h3>
    </div>

    <div class="section">
      <h3 class="section-title inline-title editable" @dblclick="editField($event, 'sectionTitle', uiConfig.sectionTitles?.financials, 'financials')">
        <span x-text="uiConfig.sectionTitles?.financials"></span>
        <template x-for="(item, i) in financials" :key="item.id || i">
          <span class="inline-financial">
            <span class="editable financial-label" @dblclick="editField($event, 'financialName', item.name, i)" x-text="item.name + ':'"></span>
            <span x-text="item.currency_symbol || uiHints.symbols?.currency_default"></span>
            <input type="text" class="mini-input inline-input" x-model="item.value" :placeholder="item.placeholder || uiHints.placeholders?.financial_value" @change="saveData();">
            <span class="editable" @dblclick="editField($event, 'financialAccount', item.account, i)" x-text="item.account"></span>
          </span>
        </template>
      </h3>
    </div>
  </div>

  <div class="dropdown" :class="{'show': showCitySelector}" data-dropdown="city">
    <div class="dropdown-content">
      <template x-for="cityItem in cityOptions" :key="cityItem.name">
        <div class="dropdown-item" @click="selectCity(cityItem)" x-text="cityItem.name"></div>
      </template>
    </div>
  </div>

  <div class="dropdown" :class="{'show': showWeekSelector}" data-dropdown="week">
    <div class="dropdown-content">
      <template x-if="savedWeeks.length > 0">
        <template x-for="week in savedWeeks" :key="week.iso_week">
          <div class="flex between center dropdown-item" :class="{'current': week.isCurrent}">
            <span @click="confirmLoadWeek(week.iso_week)" x-text="`${week.iso_week} (${week.dateRange})${week.hasUnsavedChanges ? ' *' : ''}${week.source === 'local' ? ' 📱' : ''}`"></span>
            <span @click="confirmDeleteWeek(week.iso_week)" class="delete-week-btn">×</span>
          </div>
        </template>
      </template>
      <template x-if="savedWeeks.length === 0">
        <div class="dropdown-item-empty" x-text="uiHints.placeholders?.no_saved_schedules || 'No saved schedules'"></div>
      </template>
    </div>
  </div>
</body>
</html>
