<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PocketBase Setup</title>
    <script src="https://cdn.jsdelivr.net/npm/pocketbase@latest/dist/pocketbase.umd.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            background: #fff; color: #333; padding: 10px; min-height: 100vh; line-height: 1.3;
        }
        .container { max-width: 100%; }
        h1 { color: #333; margin-bottom: 10px; font-size: 1.2em; font-weight: 400; }
        .info-box { border: 1px solid #e0e0e0; padding: 8px; margin-bottom: 10px; color: #666; font-size: 13px; }
        .form-group { margin-bottom: 8px; }
        label { display: block; margin-bottom: 3px; color: #333; font-weight: 500; font-size: 13px; }
        input, textarea {
            width: 100%; padding: 6px; background: #fff; border: 1px solid #ddd;
            color: #333; font-size: 13px;
        }
        input:focus, textarea:focus { outline: none; border-color: #333; }
        textarea { min-height: 60px; resize: vertical; font-family: monospace; }
        button {
            width: 100%; padding: 8px; margin-top: 10px; background: #fff;
            border: 1px solid #333; color: #333; cursor: pointer; font-size: 13px;
        }
        button:hover { background: #333; color: #fff; }
        #logContainer { margin-top: 15px; }
        #logContainer h2 { color: #333; margin-bottom: 5px; font-weight: 400; font-size: 1.1em; }
        pre#logOutput {
            background: #f8f8f8; border: 1px solid #e0e0e0; padding: 8px;
            max-height: 200px; overflow-y: auto; white-space: pre-wrap; 
            font-size: 11px; line-height: 1.2;
        }
        .log-entry { padding: 1px 0; }
        .log-entry.error { color: #d73027; }
        .log-entry.success { color: #1a9641; }
        .log-entry.warning { color: #f46d43; }
        .log-entry.info { color: #4575b4; }
    </style>
</head>
<body>
    <div class="container">
        <h1>PocketBase Setup</h1>
        
        <div class="info-box">
            Normalized schema: Templates as single source of truth, planners store only user data.
        </div>

        <div class="form-group">
            <label for="pbUrl">URL:</label>
            <input type="text" id="pbUrl" value="/">
        </div>
        <div class="form-group">
            <label for="adminEmail">Email:</label>
            <input type="text" id="adminEmail" placeholder="admin@example.com">
        </div>
        <div class="form-group">
            <label for="adminPassword">Password:</label>
            <input type="password" id="adminPassword">
        </div>
        <div class="form-group">
            <label for="schemaJson">Schema:</label>
            <textarea id="schemaJson" rows="6"></textarea>
        </div>
         <div class="form-group">
            <label for="seedDataJson">Seed Data:</label>
            <textarea id="seedDataJson" rows="8"></textarea>
        </div>

        <button id="setupButton">EXECUTE</button>

        <div id="logContainer">
            <h2>Output</h2>
            <pre id="logOutput"></pre>
        </div>
    </div>

<script>
const generateId = (prefix = 'id') => `${prefix}_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;

// Normalized schema - single source of truth
const schema = [
  { 
    name: "templates", type: "base", system: false, 
    listRule: null, viewRule: null, createRule: "", updateRule: "", deleteRule: "", options: {},
    fields: [
      {name: "name", type: "text", required: true, unique: true, presentable: true, options: {pattern: "^[a-zA-Z0-9_\\-]+$"}},
      {name: "description", type: "text", required: false, options: {}}, 
      {name: "is_default", type: "bool", required: false, options: {}},
      {name: "version", type: "number", required: false, options: {min:1}}, 
      {name: "structure", type: "json", required: true, options: {maxSize: 5242880}}
    ]
  },
  { 
    name: "planners", type: "base", system: false, 
    listRule: null, viewRule: null, createRule: "", updateRule: "", deleteRule: "", options: {},
    fields: [
      {name: "week_id", type: "text", required: true, unique: true, presentable: true, options: {}},
      {name: "template_id", type: "relation", required: true, options: {collectionId: "", cascadeDelete: false, minSelect: null, maxSelect: 1, displayFields: ["name"]}},
      {name: "title", type: "text", required: false, options: {}},
      {name: "city", type: "text", required: false, options: {}},
      {name: "date_range", type: "text", required: false, options: {}},
      {name: "prayer_times", type: "json", required: false, options: {maxSize: 1048576}},
      {name: "schedule_data", type: "json", required: false, options: {maxSize: 5242880}},
      {name: "tasks_data", type: "json", required: false, options: {maxSize: 5242880}},
      {name: "workout_data", type: "json", required: false, options: {maxSize: 5242880}},
      {name: "meals_data", type: "json", required: false, options: {maxSize: 5242880}},
      {name: "grocery_data", type: "json", required: false, options: {maxSize: 5242880}},
      {name: "measurements_data", type: "json", required: false, options: {maxSize: 5242880}},
      {name: "financials_data", type: "json", required: false, options: {maxSize: 5242880}}
    ]
  }
];

// Template seed data
const seedData = [
    {
        collection: "templates",
        identifierField: "name",
        data: [
            {
                name: "enhanced-weekly-v3", 
                description: "Enhanced weekly planner with project management - normalized", 
                is_default: true, 
                version: 3,
                structure: {
                    ui: {
                        title_default: "My Weekly Plan & Projects",
                        headers: {
                            main_table: ['TIME', 'DAY', 'ACTIVITY', 'SCR', 'MAX', 'ðŸ”¥'],
                            days: ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'],
                            max_cols: Array(7).fill('MAX'),
                            tasks: ['â„–', 'ðŸ”¥', 'ðŸ·ï¸', 'âœï¸ Task/Project', 'ðŸ“… Start', 'ðŸŽ¯ Due', 'âœ… Done', 'â° Delay', 'âœ“']
                        },
                        sections: {
                            tasks: 'TASKS & PROJECT MANAGEMENT',
                            workout: 'WORKOUT PLAN',
                            meals: 'MEAL PREP',
                            grocery: 'GROCERY LIST',
                            measurements: 'BODY MEASUREMENTS',
                            financials: 'MONTH/1ST: FINANCIAL'
                        }
                    },
                    prayer_times: [
                        { label: 'Q', value: '' }, { label: 'F', value: '' }, { label: 'D', value: '' }, 
                        { label: 'A', value: '' }, { label: 'M', value: '' }, { label: 'I', value: '' }
                    ],
                    schedule: [
                        { 
                            name: 'QIYAM', 
                            activities: [ 
                                { name: 'DAILY: Wakeup early', max_per_day: 1, max_score: 7 },
                                { name: 'DAILY: Qiyam/Tahajjud', max_per_day: 1, max_score: 7 },
                                { name: 'DAILY: Nutty Pudding', max_per_day: 1, max_score: 7 }
                            ]
                        },
                        { 
                            name: 'FAJR', 
                            activities: [ 
                                { name: 'DAILY: Fajr prayer', max_per_day: 1, max_score: 7 },
                                { name: 'DAILY: Quran - 1 Juz', max_per_day: 1, max_score: 7 },
                                { name: 'DAILY: 5min Cold Shower', max_per_day: 1, max_score: 7 }
                            ]
                        },
                        { 
                            name: '7AM - 9AM', 
                            activities: [ 
                                { name: 'MON/THU: COMMUTE', days: ['mon', 'thu'], max_per_day: 1, max_score: 2 },
                                { name: 'TUE/WED/FRI: Reading/Study', days: ['tue', 'wed', 'fri'], max_per_day: 1, max_score: 3 },
                                { name: 'SAT: Errands, Grocery, Meal prep', days: ['sat'], max_per_day: 3, max_score: 3 },
                                { name: 'SUN: House cleaning, laundry', days: ['sun'], max_per_day: 2, max_score: 2 }
                            ]
                        },
                        { 
                            name: 'TOTAL', 
                            activities: [ 
                                { name: 'DAILY POINTS', max_per_day: 0, max_score: 0 }
                            ]
                        }
                    ],
                    tasks: {
                        count: 15,
                        fields: ['num', 'priority', 'tag', 'description', 'start_date', 'expected_date', 'actual_date', 'completed']
                    },
                    workout: [
                        { 
                            name: 'TUESDAY', 
                            exercises: [ 
                                { name: 'Incline Dumbbell Press', default_weight: 30, default_sets: 3, default_reps: 12 },
                                { name: 'Barbell Squats', default_weight: 80, default_sets: 3, default_reps: 8 },
                                { name: 'DB Chest-Supported Row', default_weight: 25, default_sets: 3, default_reps: 12 }
                            ]
                        },
                        { 
                            name: 'WEDNESDAY', 
                            exercises: [ 
                                { name: 'Barbell Bench Press', default_weight: 70, default_sets: 3, default_reps: 6 },
                                { name: 'Romanian Deadlift', default_weight: 90, default_sets: 3, default_reps: 8 },
                                { name: 'Lat Pulldown', default_weight: 60, default_sets: 3, default_reps: 12 }
                            ]
                        },
                        { 
                            name: 'FRIDAY', 
                            exercises: [ 
                                { name: 'Seated DB Shoulder Press', default_weight: 20, default_sets: 3, default_reps: 12 },
                                { name: 'Dumbbell Row', default_weight: 25, default_sets: 3, default_reps: 12 },
                                { name: 'Barbell Hip Thrust', default_weight: 100, default_sets: 3, default_reps: 15 }
                            ]
                        }
                    ],
                    meals: [
                        { name: 'Nutty Pudding', ingredients: 'Berries Â½c, Cherries 3, Macadamia nuts 45g...' },
                        { name: 'Super Veggie', ingredients: 'Broccoli 250g, Cauliflower 150g, Mushrooms 50g...' },
                        { name: 'Third Meal', ingredients: 'Sweet Potato 350g, Protein 100g, Avocado Â½...' }
                    ],
                    grocery: {
                        budget_default: '120',
                        categories: [
                            { name: 'Produce', items: 'Broccoli, Cauliflower, Mushrooms...' },
                            { name: 'Protein', items: 'Lentils, Protein powder, Milk...' }
                        ]
                    },
                    measurements: [
                        { name: 'Weight', placeholder: '75kg' },
                        { name: 'Chest', placeholder: '42in' },
                        { name: 'Waist', placeholder: '34in' }
                    ],
                    financials: [
                        { name: 'Rent', placeholder: '850', account: 'Cash' },
                        { name: 'Allowance', placeholder: '850', account: 'Revolut' },
                        { name: 'Savings', placeholder: '3800', account: 'HSBCUK' }
                    ],
                    city_default: "London"
                }
            }
        ]
    }
];

// UI setup
document.getElementById('schemaJson').value = JSON.stringify(schema, null, 2);
document.getElementById('seedDataJson').value = JSON.stringify(seedData, null, 2);

function logMessage(message, type = 'info') {
    const p = document.createElement('p');
    p.className = `log-entry ${type}`;
    p.textContent = message;
    document.getElementById('logOutput').appendChild(p);
    document.getElementById('logOutput').scrollTop = document.getElementById('logOutput').scrollHeight;
}

document.getElementById('setupButton').addEventListener('click', async () => {
    const logOutput = document.getElementById('logOutput');
    logOutput.innerHTML = '';
    
    const pbUrl = document.getElementById('pbUrl').value.trim();
    const adminEmail = document.getElementById('adminEmail').value.trim();
    const adminPassword = document.getElementById('adminPassword').value;

    if (!pbUrl || !adminEmail || !adminPassword) {
        logMessage('URL, Email, and Password are required.', 'error');
        return;
    }

    let collectionsSchema, seedDataConfig;
    try {
        collectionsSchema = JSON.parse(document.getElementById('schemaJson').value);
        if (!Array.isArray(collectionsSchema)) throw new Error('Schema must be an array.');
    } catch (e) {
        logMessage('Schema parse error: ' + e.message, 'error');
        return;
    }

    try {
        seedDataConfig = JSON.parse(document.getElementById('seedDataJson').value);
        if (!Array.isArray(seedDataConfig)) throw new Error('Seed data must be an array.');
    } catch (e) {
        logMessage('Seed data parse error: ' + e.message, 'error');
        return;
    }

    const pb = new PocketBase(pbUrl);
    try {
        logMessage(`Authenticating ${adminEmail}...`);
        await pb.admins.authWithPassword(adminEmail, adminPassword);
        logMessage('Authentication successful.', 'success');

        logMessage('\n--- Processing Collections ---', 'info');
        let templatesCollectionId = null;
        
        for (const colDef of collectionsSchema) {
            if (!colDef.name) {
                logMessage('Skipping collection without name.', 'warning');
                continue;
            }
            
            logMessage(`Processing: ${colDef.name}`);
            const payload = {
                name: colDef.name, type: colDef.type || 'base', system: colDef.system || false,
                listRule: colDef.listRule !== undefined ? colDef.listRule : null,
                viewRule: colDef.viewRule !== undefined ? colDef.viewRule : null,
                createRule: colDef.createRule !== undefined ? colDef.createRule : "",
                updateRule: colDef.updateRule !== undefined ? colDef.updateRule : "",
                deleteRule: colDef.deleteRule !== undefined ? colDef.deleteRule : "",
                options: colDef.options || {}, fields: [], indexes: []
            };
            
            if (colDef.fields && Array.isArray(colDef.fields)) {
                payload.fields = colDef.fields.map(f => ({
                    name: f.name, type: f.type, required: f.required || false,
                    system: f.system || false, options: f.options || {}
                }));
                
                colDef.fields.forEach(f => {
                    if (f.unique) {
                        payload.indexes.push(`CREATE UNIQUE INDEX idx_uniq_${colDef.name.replace(/\W/g, '_')}_${f.name.replace(/\W/g, '_')} ON {{${colDef.name}}} (${f.name})`);
                    }
                });
                
                if (payload.indexes.length === 0) delete payload.indexes;
            }
            
            try {
                let existing = null;
                try {
                    existing = await pb.collections.getOne(colDef.name);
                } catch (e) {
                    // Not found
                }
                
                if (existing) {
                    logMessage(`Collection "${colDef.name}" exists. Updating.`, 'warning');
                    const updatePayload = { ...payload };
                    delete updatePayload.name;
                    delete updatePayload.type;
                    delete updatePayload.indexes;
                    if (updatePayload.fields) {
                        updatePayload.fields = updatePayload.fields.filter(f => !f.system);
                    }
                    const updated = await pb.collections.update(existing.id, updatePayload);
                    logMessage(`Updated "${updated.name}".`, 'success');
                    if (colDef.name === 'templates') templatesCollectionId = updated.id;
                } else {
                    const created = await pb.collections.create(payload);
                    logMessage(`Created "${created.name}".`, 'success');
                    if (colDef.name === 'templates') templatesCollectionId = created.id;
                }
            } catch (e) {
                logMessage(`Error with "${colDef.name}": ${e.message}`, 'error');
                if (e.data?.data) logMessage(JSON.stringify(e.data.data, null, 2), 'error');
            }
        }

        // Update planners collection relation
        if (templatesCollectionId) {
            try {
                const plannersCollection = await pb.collections.getOne('planners');
                const templateField = plannersCollection.fields.find(f => f.name === 'template_id');
                if (templateField) {
                    templateField.options.collectionId = templatesCollectionId;
                    await pb.collections.update(plannersCollection.id, { fields: plannersCollection.fields });
                    logMessage('Updated planners template relation.', 'success');
                }
            } catch (e) {
                logMessage('Relation update warning: ' + e.message, 'warning');
            }
        }

        logMessage('--- Collections processed ---', 'info');

        logMessage('\n--- Processing Seed Data ---', 'info');
        for (const seedConfig of seedDataConfig) {
            if (!seedConfig.collection || !seedConfig.data || !Array.isArray(seedConfig.data) || !seedConfig.identifierField) {
                logMessage('Invalid seed config.', 'warning');
                continue;
            }
            
            logMessage(`Seeding: ${seedConfig.collection}`);
            for (const recordData of seedConfig.data) {
                const identifierValue = recordData[seedConfig.identifierField];
                if (identifierValue === undefined) {
                    logMessage(`Missing identifier field.`, 'warning');
                    continue;
                }
                
                logMessage(`Record ${seedConfig.identifierField} = "${identifierValue}"`);
                try {
                    const filter = `${seedConfig.identifierField} = "${identifierValue}"`;
                    await pb.collection(seedConfig.collection).getFirstListItem(filter);
                    logMessage(`Exists. Skipping.`, 'warning');
                } catch (e) {
                    if (e.status === 404) {
                        try {
                            await pb.collection(seedConfig.collection).create(recordData);
                            logMessage(`Created.`, 'success');
                        } catch (crE) {
                            logMessage(`Creation error: ${crE.message}`, 'error');
                            if (crE.data?.data) logMessage(JSON.stringify(crE.data.data, null, 2), 'error');
                        }
                    } else {
                        logMessage(`Check error: ${e.message}`, 'error');
                    }
                }
            }
        }
        
        logMessage('--- Seed data processed ---', 'info');
        logMessage('\nSetup complete. Templates are single source of truth.', 'success');
    } catch (e) {
        logMessage('Setup error: ' + e.message, 'error');
        if (e.data?.data) logMessage(JSON.stringify(e.data.data, null, 2), 'error');
    } finally {
        pb.authStore.clear();
        logMessage('Session cleared.', 'info');
    }
});
</script>
</body>
</html>
