<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PocketBase Setup - Single Source of Truth</title>
    <script src="https://unpkg.com/pocketbase@latest/dist/pocketbase.umd.js"></script>
    <style>
        :root{--primary:#007bff;--success:#28a745;--warning:#ffc107;--danger:#dc3545;--light:#f8f9fa;--dark:#343a40}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font:11px/1.2 monospace;padding:4px;background:#f9f9f9;color:#333}
        .container{max-width:1400px;background:white;padding:6px;border-radius:2px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
        h1{font-size:14px;font-weight:600;margin-bottom:4px;border-bottom:1px solid #ddd;padding-bottom:2px}
        h2{font-size:12px;font-weight:500;margin:6px 0 3px 0;color:#555}
        .btn{padding:3px 6px;border:0;border-radius:2px;cursor:pointer;font-size:10px;margin:1px;background:var(--primary);color:white}
        .btn:disabled{background:#ccc}.btn:hover:not(:disabled){filter:brightness(0.9)}
        .btn-danger{background:var(--danger)}.btn-warning{background:var(--warning)}.btn-success{background:var(--success)}
        .row{display:flex;gap:4px;margin:3px 0}.col{flex:1}
        .editor{width:100%;min-height:150px;font:10px monospace;border:1px solid #ccc;border-radius:2px;padding:3px;resize:vertical}
        .editor:focus{outline:none;border-color:var(--primary)}
        input{width:100%;padding:2px;border:1px solid #ccc;border-radius:2px;font-size:10px}
        label{display:block;font-weight:500;font-size:9px;margin-bottom:1px}
        .status{padding:2px 4px;border-radius:2px;font-size:9px;margin-top:2px}
        .valid{background:#d4edda;color:#155724}.invalid{background:#f8d7da;color:#721c24}.warning{background:#fff3cd;color:#856404}
        .stats{display:flex;gap:8px;padding:3px;background:#e9ecef;border-radius:2px;margin:3px 0;font-size:9px}
        .stat{text-align:center}.stat-val{font-weight:bold;font-size:11px;display:block}
        #output{margin-top:4px;padding:3px;background:#222;color:#eee;border-radius:2px;font:8px monospace;max-height:200px;overflow-y:auto}
        .log-error{color:#ff6b6b}.log-success{color:#51cf66}.log-warning{color:#ffd43b}.log-info{color:#74c0fc}
        .progress{width:100%;height:2px;background:#e9ecef;border-radius:1px;margin:2px 0}
        .progress-fill{height:100%;background:var(--primary);transition:width 0.3s}
        .toggle-pass{position:absolute;right:2px;top:1px;padding:1px 4px;font-size:8px;background:var(--light);border:1px solid #ddd;cursor:pointer}
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ PocketBase Setup - Single Source of Truth</h1>
        
        <div class="stats">
            <div class="stat"><span class="stat-val" id="collCount">0</span>Collections</div>
            <div class="stat"><span class="stat-val" id="fieldCount">0</span>Fields</div>
            <div class="stat"><span class="stat-val" id="seedCount">0</span>Seeds</div>
            <div class="stat"><span class="stat-val" id="healthStat">‚ùì</span>Health</div>
        </div>
        
        <div class="progress"><div class="progress-fill" id="progress" style="width:0%"></div></div>
        
        <div class="row">
            <div class="col">
                <label>PocketBase URL:</label>
                <input id="url" value="/" placeholder="http://localhost:8090">
            </div>
            <div class="col">
                <label>Admin Email:</label>
                <input id="email" value="admin@example.com">
            </div>
            <div class="col">
                <label>Password:</label>
                <div style="position:relative">
                    <input id="pass" type="password" value="unifiedpassword">
                    <button type="button" id="togglePass" class="toggle-pass" title="Show password">üëÅÔ∏è</button>
                </div>
            </div>
        </div>
        
        <div class="row">
            <button id="health" class="btn">üîç Test</button>
            <button id="setup" class="btn" disabled>üöÄ Setup</button>
            <button id="validate" class="btn" disabled>‚úÖ Validate</button>
            <button id="reset" class="btn btn-danger">üóëÔ∏è Reset</button>
            <button id="export" class="btn btn-warning">üíæ Export</button>
            <button id="import" class="btn">üìÅ Import</button>
        </div>
        
        <div class="row">
            <div class="col">
                <h2>üìã Collections Schema</h2>
                <textarea id="collections" class="editor" readonly></textarea>
                <div id="collStatus" class="status valid">Auto-generated from single source</div>
            </div>
            <div class="col">
                <h2>üå± Seed Data</h2>
                <textarea id="seeds" class="editor" readonly></textarea>
                <div id="seedStatus" class="status valid">Auto-generated from single source</div>
            </div>
        </div>
        
        <div id="output"></div>
    </div>

<script>
// Single Source of Truth - All configuration in one place
const PLANNER_SCHEMA = {
  collections: {
    settings: {
      name: "settings",
      type: "base", 
      rules: {listRule: "", viewRule: "", createRule: "", updateRule: "", deleteRule: ""},
      fields: [
        {name: "category", type: "text", required: true, presentable: true, max: 50},
        {name: "key", type: "text", required: true, presentable: true, max: 100},
        {name: "value", type: "json", required: true, presentable: false},
        {name: "description", type: "text", required: false, presentable: true, max: 500},
        {name: "is_default", type: "bool", required: false, presentable: true}
      ]
    },
    templates: {
      name: "templates",
      type: "base",
      rules: {listRule: "", viewRule: "", createRule: "", updateRule: "", deleteRule: ""},
      fields: [
        {name: "name", type: "text", required: true, presentable: true, max: 100, pattern: "^[a-zA-Z0-9_\\-]+$"},
        {name: "description", type: "text", required: false, presentable: true, max: 500},
        {name: "is_default", type: "bool", required: false, presentable: true},
        {name: "version", type: "number", required: false, presentable: true, min: 1, noDecimal: true},
        {name: "structure", type: "json", required: true, presentable: false}
      ]
    },
    planners: {
      name: "planners",
      type: "base",
      rules: {listRule: "", viewRule: "", createRule: "", updateRule: "", deleteRule: ""},
      fields: [
        {name: "week_id", type: "text", required: true, presentable: true, max: 50},
        {name: "title", type: "text", required: false, presentable: true, max: 200},
        {name: "city", type: "text", required: false, presentable: true, max: 100},
        {name: "date_range", type: "text", required: false, presentable: true, max: 100},
        {name: "prayer_times", type: "json", required: false, presentable: false},
        {name: "schedule_data", type: "json", required: false, presentable: false},
        {name: "tasks_data", type: "json", required: false, presentable: false},
        {name: "workout_data", type: "json", required: false, presentable: false},
        {name: "meals_data", type: "json", required: false, presentable: false},
        {name: "grocery_data", type: "json", required: false, presentable: false},
        {name: "measurements_data", type: "json", required: false, presentable: false},
        {name: "financials_data", type: "json", required: false, presentable: false}
      ]
    }
  },
  
  seeds: {
    settings: [
      {
        category: "locations", key: "cities",
        value: [
          {name: 'London', latitude: 51.5074, longitude: -0.1278},
          {name: 'Cairo', latitude: 30.0444, longitude: 31.2357},
          {name: 'Cape Town', latitude: -33.9249, longitude: 18.4241},
          {name: 'Amsterdam', latitude: 52.3676, longitude: 4.9041},
          {name: 'New York', latitude: 40.7128, longitude: -74.0060},
          {name: 'Tokyo', latitude: 35.6762, longitude: 139.6503},
          {name: 'Current Location', latitude: null, longitude: null}
        ],
        description: "Available cities for prayer times and location selection",
        is_default: true
      },
      {
        category: "ui", key: "layout",
        value: {task_rows: 15, workout_days: 3, meal_items: 8, grocery_categories: 6, measurements_count: 6, financials_count: 4, prayer_times_count: 6},
        description: "Default number of rows/items for each planner section",
        is_default: true
      },
      {
        category: "ui", key: "table_columns",
        value: {
          main_schedule: {time_col_width: "18mm", day_col_width: "18mm", activity_col_width: "88mm", day_value_width: "3.5mm", max_value_width: "3.5mm", score_col_width: "8mm", streak_col_width: "6mm"},
          task_table: {num_width: "4mm", priority_width: "4mm", tag_width: "4mm", description_width: "130mm", start_date_width: "6mm", due_date_width: "6mm", done_date_width: "6mm", delay_width: "6mm", complete_width: "4mm"}
        },
        description: "Column widths for main schedule and task tables",
        is_default: true
      },
      {
        category: "ui", key: "colors",
        value: {current_day_bg: "#fff8e1", score_low: "#f8d7da", score_medium: "#fff3cd", score_high: "#d4edda", progress_low: "#dc3545", progress_medium: "#ffc107", progress_high: "#28a745", task_completed: "#d4edda", task_delayed: "#f8d7da", task_early: "#d1ecf1"},
        description: "Color scheme for the planner interface",
        is_default: true
      },
      {
        category: "defaults", key: "planner",
        value: {default_city: "London", default_currency: "¬£", default_weight_unit: "kg", default_distance_unit: "km", auto_save_interval: 30000, prayer_time_method: 2},
        description: "Default values for new planners",
        is_default: true
      },
      {
        category: "features", key: "enabled",
        value: {prayer_times: true, geolocation: true, offline_sync: true, auto_backup: true, streak_tracking: true, progress_bars: true, task_delay_tracking: true, workout_tracking: true},
        description: "Feature toggles for the application",
        is_default: true
      }
    ],
    templates: [
      {
        name: "enhanced-weekly-v2",
        description: "Enhanced weekly planner template with project management features, version 2.",
        is_default: true,
        version: 2,
        structure: {
          ui: {
            title_default: "My Weekly Plan & Projects",
            headers: {
              main_table: ['TIME', 'DAY', 'ACTIVITY', 'SCR', 'MAX', 'üî•'],
              days: ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'],
              max_cols: Array(7).fill('MAX'),
              tasks: ['‚Ññ', 'üî•', 'üè∑Ô∏è', '‚úèÔ∏è Task/Project/Note', 'üìÖ', 'üéØ', '‚úÖ', '‚è∞', '‚úì']
            },
            task_column_widths: ['4mm', '4mm', '4mm', '130mm', '6mm', '6mm', '6mm', '6mm', '4mm'],
            sections: {tasks: 'TASKS & PROJECT MANAGEMENT', workout: 'WORKOUT PLAN', meals: 'MEAL PREP', grocery: 'GROCERY LIST', measurements: 'BODY MEASUREMENTS', financials: 'MONTH/1ST: FINANCIAL'}
          },
          prayer_times: [
            {label: 'Q', value: ''}, {label: 'F', value: ''}, {label: 'D', value: ''},
            {label: 'A', value: ''}, {label: 'M', value: ''}, {label: 'I', value: ''}
          ],
          schedule: [
            {name: 'QIYAM', activities: [{name: 'DAILY: Wakeup early', max_per_day: 1, max_score: 7}, {name: 'DAILY: Qiyam/Tahajjud', max_per_day: 1, max_score: 7}, {name: 'DAILY: Nutty Pudding', max_per_day: 1, max_score: 7}]},
            {name: 'FAJR', activities: [{name: 'DAILY: Fajr prayer', max_per_day: 1, max_score: 7}, {name: 'DAILY: Quran - 1 Juz', max_per_day: 1, max_score: 7}, {name: 'DAILY: 5min Cold Shower', max_per_day: 1, max_score: 7}]},
            {name: '7AM - 9AM', activities: [{name: 'MON/THU: COMMUTE', days: ['mon', 'thu'], max_per_day: 1, max_score: 2}, {name: 'TUE/WED/FRI: Reading/Study (book/course/skill)', days: ['tue', 'wed', 'fri'], max_per_day: 1, max_score: 3}, {name: 'SAT: Errands, Grocery shopping, Meal prep', days: ['sat'], max_per_day: 3, max_score: 3}, {name: 'SUN: House cleaning, laundry', days: ['sun'], max_per_day: 2, max_score: 2}]},
            {name: '9AM - 5PM', activities: [{name: 'MON - FRI: Work', days: ['mon', 'tue', 'wed', 'thu', 'fri'], max_per_day: 1, max_score: 5}, {name: 'DAILY: ZeroInbox (E1, E2, E3, E4, LI, Slack)', days: ['mon', 'tue', 'wed', 'thu', 'fri'], max_per_day: 6, max_score: 30}, {name: 'SAT/SUN: Nature time / Outdoor Activity / Adventure', days: ['sat', 'sun'], max_per_day: 1, max_score: 2}]},
            {name: 'DHUHR', activities: [{name: 'DAILY: Dhuhr prayer', max_per_day: 1, max_score: 7}, {name: 'TUE/WED/FRI: Sun walk (30-45 minutes)', days: ['tue', 'wed', 'fri'], max_per_day: 1, max_score: 3}, {name: 'FRI: ¬£10 Sadaqa', days: ['fri'], max_per_day: 1, max_score: 1}]},
            {name: 'ASR', activities: [{name: 'DAILY: Asr prayer', max_per_day: 1, max_score: 7}]},
            {name: '5PM - 6:30PM', activities: [{name: 'MON/THU: COMMUTE', days: ['mon', 'thu'], max_per_day: 1, max_score: 2}, {name: 'TUE/WED/FRI: Workout', days: ['tue', 'wed', 'fri'], max_per_day: 1, max_score: 3}, {name: 'TUE/WED/FRI: Third Meal', days: ['tue', 'wed', 'fri'], max_per_day: 1, max_score: 3}]},
            {name: '6:30PM - ISHA', activities: [{name: 'MON/TUE/WED/THU: Personal', days: ['mon', 'tue', 'wed', 'thu'], max_per_day: 1, max_score: 4}, {name: 'DAILY: Family/Friends/Date calls(M, WA, Phone)', days: ['mon', 'tue', 'wed', 'thu'], max_per_day: 3, max_score: 12}, {name: 'FRI/SAT/SUN: Family/Friends/Date visits/outings/activities', days: ['fri', 'sat', 'sun'], max_per_day: 3, max_score: 9}]},
            {name: 'MAGHRIB', activities: [{name: 'DAILY: Maghrib prayer', max_per_day: 1, max_score: 7}, {name: 'DAILY: Super Veggie', max_per_day: 1, max_score: 7}]},
            {name: 'ISHA', activities: [{name: 'DAILY: Isha prayer', max_per_day: 1, max_score: 7}, {name: 'DAILY: Sleep early', max_per_day: 1, max_score: 7}]},
            {name: 'ALLDAY', activities: [{name: 'DAILY: No Doomscrolling; (FB, YTB, LKDN, & IG)', max_per_day: 4, max_score: 28}, {name: 'DAILY: No Fap; (P, & M)', max_per_day: 2, max_score: 14}, {name: 'DAILY: No Processed; (Sugar, RefinedFlour, SeedOils, Soda, FastFood)', max_per_day: 5, max_score: 35}, {name: 'MON/THU: Fasting', days: ['mon', 'thu'], max_per_day: 1, max_score: 2}, {name: 'DAILY: Expense Tracker <25', max_per_day: 0, max_score: 0}]},
            {name: 'TOTAL', activities: [{name: 'DAILY POINTS', max_per_day: 0, max_score: 0}]}
          ],
          tasks: {count: 15, fields: ['num', 'priority', 'tag', 'description', 'start_date', 'expected_date', 'actual_date', 'completed']},
          workout: [
            {name: 'TUESDAY', exercises: [{name: 'Incline Dumbbell Press', default_weight: 30, default_sets: 3, default_reps: 12}, {name: 'Barbell Squats', default_weight: 80, default_sets: 3, default_reps: 8}, {name: 'DB Chest-Supported Row', default_weight: 25, default_sets: 3, default_reps: 12}, {name: 'Leg Curls', default_weight: 40, default_sets: 3, default_reps: 15}, {name: 'Incline DB Curls (SS)', default_weight: 15, default_sets: 3, default_reps: 12}, {name: 'Tricep Extensions (SS)', default_weight: 20, default_sets: 3, default_reps: 12}]},
            {name: 'WEDNESDAY', exercises: [{name: 'Barbell Bench Press', default_weight: 70, default_sets: 3, default_reps: 6}, {name: 'Romanian Deadlift', default_weight: 90, default_sets: 3, default_reps: 8}, {name: 'Lat Pulldown', default_weight: 60, default_sets: 3, default_reps: 12}, {name: 'Walking Lunges', default_weight: 20, default_sets: 3, default_reps: 10}, {name: 'Cable Lateral Raises (SS)', default_weight: 15, default_sets: 3, default_reps: 15}, {name: 'Reverse Crunches (SS)', default_weight: 0, default_sets: 3, default_reps: 15}]},
            {name: 'FRIDAY', exercises: [{name: 'Seated DB Shoulder Press', default_weight: 20, default_sets: 3, default_reps: 12}, {name: 'Dumbbell Row', default_weight: 25, default_sets: 3, default_reps: 12}, {name: 'Barbell Hip Thrust', default_weight: 100, default_sets: 3, default_reps: 15}, {name: 'Leg Extensions', default_weight: 50, default_sets: 3, default_reps: 15}, {name: 'Seated Chest Flyes', default_weight: 15, default_sets: 3, default_reps: 15}, {name: 'Standing Calf Raises (SS)', default_weight: 30, default_sets: 3, default_reps: 15}, {name: 'Reverse Cable Flyes (SS)', default_weight: 20, default_sets: 3, default_reps: 15}]}
          ],
          meals: [
            {name: 'Nutty Pudding', ingredients: 'Berries ¬Ωc, Cherries 3, Pomegranate Juice 2oz, Macadamia nuts (raw) 45g, Walnuts (raw) 5g, Cocoa 1t, Brazil Nuts ¬º, Milk 50-100ml, Chia Seeds 2T, Flax (ground, refr) 1t, Lecithin 1t, Ceylon Cinnamon ¬Ωt'},
            {name: 'Super Veggie', ingredients: 'Broccoli 250g, Cauliflower 150g, Mushrooms 50g, Garlic 1 clove, Ginger 3g, Cumin 1T, Black Lentils 45g, Hemp Seeds 1T, Apple Cider Vinegar 1T'},
            {name: 'Third Meal', ingredients: 'Sweet Potato 350-400g, Protein 100-150g, Grape Tomatoes 12, Avocado ¬Ω, Radishes 4, Cilantro ¬ºc, Lemon 1, Jalape√±o (lg) 1, Chili Powder 1t'}
          ],
          grocery: {budget_default: '120', categories: [{name: 'Produce', items: 'Broccoli 1.75kg, Cauliflower 1.05kg, Mushrooms 350g, Garlic 1 bulb, Ginger 1pc, Sweet Potato 2.8kg, Grape Tomatoes 84, Avocados (ripe) 4, Radishes 28, Cilantro 2-3 bunch'}, {name: 'Fruits & Protein', items: 'Lemons 7, Jalape√±os (lg) 7, Berries 3.5c, Cherries 21, Black Lentils 315g, Protein 1.05kg, Milk (fortified) 1L'}]},
          measurements: [{name: 'Weight', placeholder: '75kg'}, {name: 'Chest', placeholder: '42in'}, {name: 'Waist', placeholder: '34in'}, {name: 'Hips', placeholder: '40in'}, {name: 'Arms', placeholder: '15in'}, {name: 'Thighs', placeholder: '24in'}],
          financials: [{name: 'Rent', placeholder: '850', account: 'Cash'}, {name: 'Allowance', placeholder: '850', account: 'Revolut'}, {name: 'Savings', placeholder: '3,800', account: 'HSBCUK'}],
          city_default: "London"
        }
      }
    ]
  }
};

// Auto-populate from single source of truth
let pb, url = '/', email = 'admin@example.com', pass = 'unifiedpassword';
const collEditor = document.getElementById('collections');
const seedEditor = document.getElementById('seeds');
const output = document.getElementById('output');
const progress = document.getElementById('progress');
const stats = {
  collections: document.getElementById('collCount'),
  fields: document.getElementById('fieldCount'), 
  seeds: document.getElementById('seedCount'),
  health: document.getElementById('healthStat')
};

// Auto-generate arrays from single source
const collections = Object.values(PLANNER_SCHEMA.collections).map(coll => ({
  ...coll.rules, name: coll.name, type: coll.type, fields: coll.fields
}));
const seeds = PLANNER_SCHEMA.seeds;

// Populate editors
collEditor.value = JSON.stringify(collections, null, 2);
seedEditor.value = JSON.stringify(seeds, null, 2);

// Update stats
const updateStats = () => {
  stats.collections.textContent = collections.length;
  stats.fields.textContent = collections.reduce((sum, c) => sum + (c.fields?.length || 0), 0);
  stats.seeds.textContent = Object.values(seeds).reduce((sum, arr) => sum + (Array.isArray(arr) ? arr.length : 0), 0);
};
updateStats();

// Logging
const log = (msg, type = 'info') => {
  const p = document.createElement('p');
  p.className = `log-${type}`;
  p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  output.appendChild(p);
  output.scrollTop = output.scrollHeight;
};

// Progress
const setProgress = (pct, status = '') => {
  progress.style.width = pct + '%';
  if (status) log(status);
};

// PocketBase operations
const healthCheck = async () => {
  setProgress(10, 'Testing connection...');
  url = document.getElementById('url').value || '/';
  email = document.getElementById('email').value || 'admin@example.com';
  pass = document.getElementById('pass').value || 'unifiedpassword';
  
  try {
    pb = new PocketBase(url);
    await pb.admins.authWithPassword(email, pass);
    
    const collections = await pb.collections.getFullList();
    log(`‚úÖ Connected. Found ${collections.length} collections`, 'success');
    
    stats.health.textContent = '‚úÖ';
    setProgress(100, 'Ready for setup');
    
    ['setup', 'validate'].forEach(id => document.getElementById(id).disabled = false);
    return true;
  } catch (e) {
    stats.health.textContent = '‚ùå';
    log(`‚ùå Connection failed: ${e.message}`, 'error');
    setProgress(0);
    return false;
  } finally {
    pb?.authStore?.clear();
  }
};

const runSetup = async () => {
  setProgress(20, 'Setting up schema...');
  
  try {
    pb = new PocketBase(url);
    await pb.admins.authWithPassword(email, pass);
    
    setProgress(40, 'Importing collections...');
    await pb.collections.import(collections, false);
    
    setProgress(60, 'Adding template relation...');
    try {
      const templatesCollection = await pb.collections.getOne('templates');
      const plannersCollection = await pb.collections.getOne('planners');
      
      if (!plannersCollection.fields.some(f => f.name === 'template_id')) {
        const relationField = {
          name: "template_id", type: "relation", required: true, presentable: true,
          collectionId: templatesCollection.id, cascadeDelete: false,
          minSelect: 1, maxSelect: 1, displayFields: ["name", "description"]
        };
        
        const updatedFields = [...plannersCollection.fields];
        updatedFields.splice(1, 0, relationField);
        
        await pb.collections.update(plannersCollection.id, {fields: updatedFields});
        log('‚úÖ Added template relation', 'success');
      }
    } catch (e) {
      log(`‚ö†Ô∏è Relation setup: ${e.message}`, 'warning');
    }
    
    setProgress(80, 'Seeding data...');
    for (const [collName, items] of Object.entries(seeds)) {
      for (const item of items) {
        try {
          await pb.collection(collName).create(item);
        } catch (e) {
          log(`‚ö†Ô∏è Seed error in ${collName}: ${e.message}`, 'warning');
        }
      }
    }
    
    setProgress(100, 'Setup complete');
    log('üéâ Full setup complete!', 'success');
    return true;
  } catch (e) {
    log(`‚ùå Setup failed: ${e.message}`, 'error');
    setProgress(0);
    return false;
  } finally {
    pb?.authStore?.clear();
  }
};

const runValidate = async () => {
  setProgress(20, 'Validating...');
  
  try {
    pb = new PocketBase(url);
    await pb.admins.authWithPassword(email, pass);
    
    const collections = await pb.collections.getFullList();
    log(`‚úÖ Found ${collections.length} collections`, 'success');
    
    const required = ['settings', 'templates', 'planners'];
    const missing = required.filter(name => !collections.find(c => c.name === name));
    
    if (missing.length > 0) {
      log(`‚ùå Missing collections: ${missing.join(', ')}`, 'error');
    } else {
      log('‚úÖ All required collections exist', 'success');
      
      for (const coll of collections) {
        const records = await pb.collection(coll.name).getList(1, 1);
        log(`‚úÖ ${coll.name}: ${records.totalItems} records`, 'success');
      }
    }
    
    setProgress(100, 'Validation complete');
    return missing.length === 0;
  } catch (e) {
    log(`‚ùå Validation failed: ${e.message}`, 'error');
    setProgress(0);
    return false;
  } finally {
    pb?.authStore?.clear();
  }
};

const resetAll = async () => {
  if (!confirm('Delete all collections?')) return;
  
  setProgress(20, 'Resetting...');
  
  try {
    pb = new PocketBase(url);
    await pb.admins.authWithPassword(email, pass);
    
    const collections = await pb.collections.getFullList();
    for (const coll of collections) {
      if (!coll.system) {
        await pb.collections.delete(coll.id);
        log(`üóëÔ∏è Deleted ${coll.name}`, 'warning');
      }
    }
    
    setProgress(100, 'Reset complete');
    log('‚úÖ Reset successful', 'success');
    
    ['setup', 'validate'].forEach(id => document.getElementById(id).disabled = true);
    stats.health.textContent = '‚ùì';
  } catch (e) {
    log(`‚ùå Reset failed: ${e.message}`, 'error');
    setProgress(0);
  } finally {
    pb?.authStore?.clear();
  }
};

// Event handlers
document.getElementById('health').onclick = healthCheck;
document.getElementById('setup').onclick = runSetup;
document.getElementById('validate').onclick = runValidate; 
document.getElementById('reset').onclick = resetAll;

document.getElementById('togglePass').onclick = () => {
  const passField = document.getElementById('pass');
  const btn = document.getElementById('togglePass');
  
  if (passField.type === 'password') {
    passField.type = 'text';
    btn.textContent = 'üôà';
  } else {
    passField.type = 'password';
    btn.textContent = 'üëÅÔ∏è';
  }
};

document.getElementById('export').onclick = () => {
  const config = {
    url: document.getElementById('url').value,
    email: document.getElementById('email').value,
    schema: PLANNER_SCHEMA
  };
  const blob = new Blob([JSON.stringify(config, null, 2)], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'planner-config.json';
  a.click();
};

document.getElementById('import').onclick = () => {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const config = JSON.parse(e.target.result);
        if (config.url) document.getElementById('url').value = config.url;
        if (config.email) document.getElementById('email').value = config.email;
        if (config.schema) {
          Object.assign(PLANNER_SCHEMA, config.schema);
          collEditor.value = JSON.stringify(Object.values(PLANNER_SCHEMA.collections), null, 2);
          seedEditor.value = JSON.stringify(PLANNER_SCHEMA.seeds, null, 2);
          updateStats();
        }
        log('‚úÖ Config imported', 'success');
      } catch (e) {
        log(`‚ùå Import error: ${e.message}`, 'error');
      }
    };
    reader.readAsText(file);
  };
  input.click();
};

// Initialize
log('üöÄ Single Source of Truth Setup Ready', 'info');
log('All configuration controlled by PLANNER_SCHEMA object', 'info');
</script>
</body>
</html>
