<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PocketBase Setup - Fixed & Robust</title>
    <script src="https://unpkg.com/pocketbase@latest/dist/pocketbase.umd.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:monospace;font-size:11px;line-height:1.1;padding:4px;background:#f9f9f9;color:#333;}
        .c{max-width:1400px;background:white;padding:6px;border-radius:2px;box-shadow:0 1px 3px rgba(0,0,0,0.1);}
        h1{font-size:14px;font-weight:600;margin-bottom:4px;border-bottom:1px solid #ddd;padding-bottom:2px;}
        h2{font-size:12px;font-weight:500;margin:6px 0 3px 0;color:#555;}
        button{padding:3px 6px;background:#007bff;color:white;border:0;border-radius:2px;cursor:pointer;font-size:10px;margin:1px;}
        button:disabled{background:#ccc;} button:hover:not(:disabled){background:#0056b3;}
        button.danger{background:#dc3545;} button.export{background:#17a2b8;} button.reset{background:#6c757d;}
        #togglePass{background:#f8f9fa !important;color:#333 !important;border:1px solid #ddd !important;z-index:10;}
        #togglePass:hover{background:#e9ecef !important;}
        .row{display:flex;gap:4px;margin:3px 0;} .col{flex:1;}
        .editor{width:100%;min-height:150px;font-family:monospace;font-size:10px;border:1px solid #ccc;border-radius:2px;padding:3px;resize:vertical;}
        .editor:focus{outline:none;border-color:#007bff;}
        input{width:100%;padding:2px;border:1px solid #ccc;border-radius:2px;font-size:10px;}
        input:focus{outline:none;border-color:#007bff;}
        #pass{padding-right:25px;}
        label{display:block;font-weight:500;font-size:9px;margin-bottom:1px;}
        .status{padding:2px 4px;border-radius:2px;font-size:9px;margin-top:2px;}
        .valid{background:#d4edda;color:#155724;} .invalid{background:#f8d7da;color:#721c24;} .warning{background:#fff3cd;color:#856404;}
        .stats{display:flex;gap:8px;padding:3px;background:#e9ecef;border-radius:2px;margin:3px 0;font-size:9px;}
        .stat{text-align:center;} .stat-val{font-weight:bold;font-size:11px;display:block;}
        #out{margin-top:4px;padding:3px;background:#222;color:#eee;border-radius:2px;font-family:monospace;font-size:8px;max-height:200px;overflow-y:auto;}
        .le{color:#ff6b6b;} .ls{color:#51cf66;} .lw{color:#ffd43b;} .li{color:#74c0fc;}
        .progress{width:100%;height:2px;background:#e9ecef;border-radius:1px;margin:2px 0;} .progress-fill{height:100%;background:#007bff;transition:width 0.3s;}
    </style>
</head>
<body>
    <div class="c">
        <h1>üöÄ PocketBase Setup - Fixed & Robust</h1>
        <div class="stats">
            <div class="stat"><span class="stat-val" id="collCount">0</span>Collections</div>
            <div class="stat"><span class="stat-val" id="fieldCount">0</span>Fields</div>
            <div class="stat"><span class="stat-val" id="seedCount">0</span>Seeds</div>
            <div class="stat"><span class="stat-val" id="healthStat">‚ùì</span>Health</div>
        </div>
        <div class="progress"><div class="progress-fill" id="progress" style="width:0%"></div></div>
        <div class="row">
            <div class="col">
                <label for="url">PocketBase URL:</label>
                <input id="url" value="/">
            </div>
            <div class="col">
                <label for="email">Admin Email:</label>
                <input id="email" value="admin@example.com">
            </div>
            <div class="col">
                <label for="pass">Password:</label>
                <div style="position:relative;">
                    <input id="pass" type="password" value="unifiedpassword">
                    <button type="button" id="togglePass" title="Show password" style="position:absolute;right:2px;top:1px;padding:1px 4px;font-size:8px;">üëÅÔ∏è</button>
                </div>
            </div>
        </div>
        <div class="row">
            <button id="health">üîç Test Connection</button>
            <button id="setup" disabled>üöÄ Full Setup</button>
            <button id="schema" disabled>üìã Schema Only</button>
            <button id="seed" disabled>üå± Seed Only</button>
            <button id="validate" disabled>‚úÖ Validate</button>
            <button id="reset" class="danger">üóëÔ∏è Reset</button>
            <button id="export" class="export">üíæ Export</button>
            <button id="import">üìÅ Import</button>
        </div>
        <div class="row">
            <div class="col">
                <h2>üìã Collections Schema</h2>
                <textarea id="collections" class="editor"></textarea>
                <div class="status" id="collStatus">Ready for validation</div>
            </div>
            <div class="col">
                <h2>üå± Seed Data</h2>
                <textarea id="seeds" class="editor"></textarea>
                <div class="status" id="seedStatus">Ready for validation</div>
            </div>
        </div>
        <div id="out"></div>
    </div>

<script>
let pb, url = '/', email = 'admin@example.com', pass = 'unifiedpassword';
const out = document.getElementById('out');
const progress = document.getElementById('progress');
const collCount = document.getElementById('collCount');
const fieldCount = document.getElementById('fieldCount');
const seedCount = document.getElementById('seedCount');
const healthStat = document.getElementById('healthStat');
const collEditor = document.getElementById('collections');
const seedEditor = document.getElementById('seeds');
const collStatus = document.getElementById('collStatus');
const seedStatus = document.getElementById('seedStatus');

const log = (msg, type = 'i') => { 
    const p = document.createElement('p'); 
    p.className = `l${type[0]}`; 
    p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`; 
    out.appendChild(p); 
    out.scrollTop = out.scrollHeight; 
};

const setProgress = (pct, status = '') => { 
    progress.style.width = pct + '%'; 
    if (status) log(status); 
};

const validateJSON = (str, name) => { 
    try { 
        const data = JSON.parse(str); 
        return { valid: true, data }; 
    } catch (e) { 
        return { valid: false, error: e.message }; 
    }
};

const updateStats = () => {
    const cr = validateJSON(collEditor.value);
    const sr = validateJSON(seedEditor.value);
    
    if (cr.valid && Array.isArray(cr.data)) {
        collCount.textContent = cr.data.length;
        let fc = 0;
        cr.data.forEach(c => {
            if (c.schema) fc += c.schema.length;
        });
        fieldCount.textContent = fc;
    } else {
        collCount.textContent = '0';
        fieldCount.textContent = '0';
    }
    
    if (sr.valid && sr.data) {
        let sc = 0;
        Object.values(sr.data).forEach(a => {
            if (Array.isArray(a)) sc += a.length;
        });
        seedCount.textContent = sc;
    } else {
        seedCount.textContent = '0';
    }
};

const healthCheck = async () => { 
    setProgress(10, 'Testing connection...');
    url = document.getElementById('url').value || '/';
    email = document.getElementById('email').value || 'admin@example.com';
    pass = document.getElementById('pass').value || 'unifiedpassword';
    
    let cs = [];
    try {
        pb = new PocketBase(url);
        await pb.admins.authWithPassword(email, pass);
        cs = await pb.collections.getFullList({requestKey: null});
        log(`‚úÖ Connected successfully. Found ${cs.length} collections.`, 's');
        healthStat.textContent = '‚úÖ';
        healthStat.title = `Connected | ${cs.length} Collections`;
        setProgress(100, 'Connection ready');
        ['setup', 'schema', 'validate'].forEach(id => document.getElementById(id).disabled = false);
        document.getElementById('seed').disabled = !(cs.length > 0);
        return true;
    } catch (e) {
        healthStat.textContent = '‚ùå';
        healthStat.title = `Failed: ${e.message}`;
        log(`‚ùå Connection failed: ${e.message}`, 'e');
        setProgress(0);
        ['setup', 'schema', 'seed', 'validate'].forEach(id => document.getElementById(id).disabled = true);
        return false;
    } finally {
        if (pb?.authStore?.isValid) pb.authStore.clear();
    }
};

// ROBUST SCHEMA SETUP WITH PROPER ERROR HANDLING
const runSchema = async () => {
    const result = validateJSON(collEditor.value, 'collections');
    if (!result.valid) {
        log('‚ùå Schema validation failed - invalid JSON', 'e');
        setProgress(0);
        return false;
    }
    
    setProgress(20, 'Authenticating...');
    log('üîë Authenticating with PocketBase...');
    
    try {
        pb = new PocketBase(url);
        await pb.admins.authWithPassword(email, pass);
        log('‚úÖ Authentication successful', 's');
        
        const collectionsToCreate = result.data;
        let createdCollections = [];
        
        setProgress(30, 'Creating collections individually...');
        
        // Get existing collections first
        const existingCollections = await pb.collections.getFullList({requestKey: null});
        const existingNames = existingCollections.map(c => c.name);
        log(`Found ${existingCollections.length} existing collections: ${existingNames.join(', ') || 'none'}`);
        
        // Create each collection individually
        for (let i = 0; i < collectionsToCreate.length; i++) {
            const coll = collectionsToCreate[i];
            const collName = coll.name;
            
            try {
                log(`Creating collection: ${collName}...`);
                
                // Check if collection already exists
                const existing = existingCollections.find(c => c.name === collName);
                
                if (existing) {
                    log(`‚ö†Ô∏è Collection '${collName}' already exists, updating schema...`, 'w');
                    const updated = await pb.collections.update(existing.id, coll, {requestKey: null});
                    createdCollections.push(updated);
                    log(`‚úÖ Updated collection: ${collName}`);
                } else {
                    const created = await pb.collections.create(coll, {requestKey: null});
                    createdCollections.push(created);
                    log(`‚úÖ Created collection: ${collName}`);
                }
                
                setProgress(30 + ((i + 1) / collectionsToCreate.length) * 40);
                
            } catch (e) {
                log(`‚ùå Failed to create/update collection '${collName}': ${e.message}`, 'e');
                console.error(`Collection ${collName} error:`, e);
                throw new Error(`Failed to create collection '${collName}': ${e.message}`);
            }
        }
        
        setProgress(70, 'Setting up relations...');
        
        // Now handle the template_id relation for planners
        const templatesCollection = createdCollections.find(c => c.name === 'templates');
        const plannersCollection = createdCollections.find(c => c.name === 'planners');
        
        if (templatesCollection && plannersCollection) {
            log('üîó Adding template_id relation to planners collection...');
            
            // Check if template_id field already exists
            const hasTemplateId = plannersCollection.schema.some(f => f.name === 'template_id');
            
            if (!hasTemplateId) {
                log('Adding template_id relation field...');
                
                const relationField = {
                    name: "template_id",
                    type: "relation",
                    required: true,
                    presentable: false,
                    system: false,
                    options: {
                        collectionId: templatesCollection.id,
                        cascadeDelete: false,
                        minSelect: 1,
                        maxSelect: 1,
                        displayFields: ["name", "version"]
                    }
                };
                
                // Add the relation field to the schema
                const newSchema = [...plannersCollection.schema];
                const weekIdIndex = newSchema.findIndex(f => f.name === 'week_id');
                if (weekIdIndex !== -1) {
                    newSchema.splice(weekIdIndex + 1, 0, relationField);
                } else {
                    newSchema.unshift(relationField);
                }
                
                try {
                    await pb.collections.update(plannersCollection.id, {schema: newSchema}, {requestKey: null});
                    log('‚úÖ template_id relation added successfully', 's');
                } catch (e) {
                    log(`‚ö†Ô∏è Could not add template_id relation: ${e.message}`, 'w');
                    console.error('Relation error:', e);
                }
            } else {
                log('üëç template_id relation already exists', 'i');
            }
        } else {
            if (!templatesCollection) log('‚ö†Ô∏è templates collection not found for relation setup', 'w');
            if (!plannersCollection) log('‚ö†Ô∏è planners collection not found for relation setup', 'w');
        }
        
        setProgress(100, 'Schema setup complete');
        log('‚úÖ Schema setup completed successfully!', 's');
        document.getElementById('seed').disabled = false;
        return true;
        
    } catch (e) {
        log(`‚ùå Schema setup failed: ${e.message}`, 'e');
        console.error("Schema error:", e);
        setProgress(0);
        return false;
    } finally {
        if (pb?.authStore?.isValid) pb.authStore.clear();
    }
};

const runSeed = async () => {
    const result = validateJSON(seedEditor.value, 'seeds');
    if (!result.valid) {
        log('‚ùå Seed validation failed - invalid JSON', 'e');
        setProgress(0);
        return false;
    }
    
    setProgress(20, 'Seeding data...');
    
    try {
        pb = new PocketBase(url);
        await pb.admins.authWithPassword(email, pass);
        
        const seedData = result.data;
        let currentProgress = 30;
        const totalCollections = Object.keys(seedData).length;
        const progressPerCollection = totalCollections > 0 ? 70 / totalCollections : 0;
        
        for (const [collectionName, items] of Object.entries(seedData)) {
            if (!Array.isArray(items) || items.length === 0) {
                log(`‚ÑπÔ∏è No items to seed for ${collectionName}`, 'i');
                continue;
            }
            
            log(`üå± Seeding ${items.length} items into ${collectionName}...`, 'i');
            
            for (const item of items) {
                try {
                    await pb.collection(collectionName).create(item, {requestKey: null});
                } catch (e) {
                    log(`‚ö†Ô∏è Seed error in ${collectionName}: ${e.message}`, 'w');
                    console.error(`Seed item error (${collectionName}):`, e, item);
                }
            }
            
            currentProgress += progressPerCollection;
            setProgress(Math.min(99, currentProgress));
        }
        
        setProgress(100, 'Seed complete');
        log('‚úÖ Seed data loaded successfully!', 's');
        return true;
        
    } catch (e) {
        log(`‚ùå Seed failed: ${e.message}`, 'e');
        console.error("Seed error:", e);
        setProgress(0);
        return false;
    } finally {
        if (pb?.authStore?.isValid) pb.authStore.clear();
    }
};

const runValidate = async () => {
    setProgress(10, 'Validating setup...');
    
    try {
        pb = new PocketBase(url);
        await pb.admins.authWithPassword(email, pass);
        log('‚úÖ Connected for validation', 's');
        
        const collections = await pb.collections.getFullList({requestKey: null});
        const userCollections = collections.filter(c => !c.system && !c.name.startsWith('_'));
        
        log(`üìä Found ${collections.length} total collections (${userCollections.length} user collections)`, 'i');
        
        const errors = [];
        const warnings = [];
        
        setProgress(30, 'Validating collections...');
        
        // Check for required collections
        const requiredCollections = ['cities', 'templates', 'planners'];
        const foundCollections = userCollections.map(c => c.name);
        
        requiredCollections.forEach(reqName => {
            if (!foundCollections.includes(reqName)) {
                errors.push(`CRITICAL: Missing required collection '${reqName}'`);
            }
        });
        
        // Validate templates collection
        const templatesCollection = userCollections.find(c => c.name === 'templates');
        if (templatesCollection) {
            const hasStructureField = templatesCollection.schema.find(f => f.name === 'structure' && f.type === 'json');
            if (!hasStructureField) {
                errors.push("'templates' collection missing 'structure' JSON field");
            }
            
            const hasDefaultField = templatesCollection.schema.find(f => f.name === 'is_default' && f.type === 'bool');
            if (!hasDefaultField) {
                warnings.push("'templates' collection missing 'is_default' boolean field");
            }
        }
        
        // Validate planners collection
        const plannersCollection = userCollections.find(c => c.name === 'planners');
        if (plannersCollection) {
            const hasWeekIdField = plannersCollection.schema.find(f => f.name === 'week_id');
            if (!hasWeekIdField) {
                errors.push("'planners' collection missing 'week_id' field");
            }
            
            const hasUserIdField = plannersCollection.schema.find(f => f.name === 'user_id' && f.type === 'relation');
            if (!hasUserIdField) {
                errors.push("'planners' collection missing 'user_id' relation field");
            }
            
            const hasTemplateIdField = plannersCollection.schema.find(f => f.name === 'template_id' && f.type === 'relation');
            if (!hasTemplateIdField) {
                warnings.push("'planners' collection missing 'template_id' relation field");
            }
        }
        
        setProgress(60, 'Validating data integrity...');
        
        // Check for default template
        if (templatesCollection) {
            try {
                const defaultTemplates = await pb.collection('templates').getFullList({
                    filter: 'is_default=true',
                    requestKey: null
                });
                
                if (defaultTemplates.length === 0) {
                    errors.push("No default template found (is_default=true). Run seed setup.");
                } else if (defaultTemplates.length > 1) {
                    errors.push("Multiple default templates found. Only one should have is_default=true.");
                } else {
                    const defaultTemplate = defaultTemplates[0];
                    if (!defaultTemplate.structure?.ui?.headers?.tasks || defaultTemplate.structure.ui.headers.tasks.length !== 9) {
                        errors.push(`Default template has ${defaultTemplate.structure?.ui?.headers?.tasks?.length || 0} task headers, expected 9`);
                    }
                    
                    if (defaultTemplate.structure?.tasks?.count === undefined) {
                        errors.push("Default template missing tasks.count property");
                    }
                    
                    const requiredPlaceholders = ['task_num_prefix', 'task_priority', 'task_tag', 'task_description', 'grocery_budget_value', 'measurement_value', 'financial_value', 'workout_weight_value', 'workout_sets_value', 'workout_reps_value', 'no_saved_schedules'];
                    
                    const missingPlaceholders = requiredPlaceholders.filter(p => 
                        defaultTemplate.structure?.ui?.placeholders?.[p] === undefined
                    );
                    
                    if (missingPlaceholders.length > 0) {
                        errors.push(`Default template missing placeholders: ${missingPlaceholders.join(', ')}`);
                    }
                    
                    const requiredSymbols = ['currency_default', 'weight_unit', 'sets_reps_separator', 'task_checkbox_empty', 'task_checkbox_checked', 'task_delay_ontime', 'default_measurement_unit', 'time_am', 'time_pm'];
                    
                    const missingSymbols = requiredSymbols.filter(s => 
                        defaultTemplate.structure?.ui?.symbols?.[s] === undefined
                    );
                    
                    if (missingSymbols.length > 0) {
                        errors.push(`Default template missing symbols: ${missingSymbols.join(', ')}`);
                    }
                }
            } catch (e) {
                errors.push(`Could not validate template data: ${e.message}`);
            }
        }
        
        setProgress(100, 'Validation complete');
        
        if (errors.length > 0) {
            log(`‚ùå VALIDATION FAILED: ${errors.length} errors, ${warnings.length} warnings`, 'e');
            errors.forEach(err => log(`  üî¥ ${err}`, 'e'));
            warnings.forEach(warn => log(`  üü° ${warn}`, 'w'));
            return false;
        }
        
        if (warnings.length > 0) {
            log(`‚ö†Ô∏è VALIDATION PASSED WITH WARNINGS: ${warnings.length} warnings`, 'w');
            warnings.forEach(warn => log(`  üü° ${warn}`, 'w'));
        } else {
            log('‚úÖ VALIDATION PASSED: All systems operational! üõ°Ô∏è', 's');
        }
        
        return true;
        
    } catch (e) {
        log(`‚ùå Validation error: ${e.message}`, 'e');
        setProgress(0);
        return false;
    } finally {
        if (pb?.authStore?.isValid) pb.authStore.clear();
    }
};

const resetAll = async () => {
    if (!confirm('‚ö†Ô∏è This will DELETE ALL non-system collections. This action CANNOT be undone.\n\nAre you absolutely sure?')) {
        return;
    }
    
    setProgress(10, 'Resetting database...');
    
    try {
        pb = new PocketBase(url);
        await pb.admins.authWithPassword(email, pass);
        
        const collections = await pb.collections.getFullList({requestKey: null});
        let deletedCount = 0;
        
        for (const collection of collections) {
            if (!collection.system) {
                try {
                    await pb.collections.delete(collection.id, {requestKey: null});
                    log(`üóëÔ∏è Deleted collection: ${collection.name}`, 'w');
                    deletedCount++;
                } catch (e) {
                    log(`‚ö†Ô∏è Could not delete ${collection.name}: ${e.message}`, 'w');
                }
            }
        }
        
        setProgress(100, 'Reset complete');
        log(`‚úÖ Reset successful. ${deletedCount} collections deleted.`, 's');
        
        // Reset UI state
        ['setup', 'schema', 'seed', 'validate'].forEach(id => document.getElementById(id).disabled = true);
        healthStat.textContent = '‚ùì';
        
    } catch (e) {
        log(`‚ùå Reset failed: ${e.message}`, 'e');
        setProgress(0);
    } finally {
        if (pb?.authStore?.isValid) pb.authStore.clear();
    }
};

// BULLETPROOF DEFAULT CONFIGURATIONS
const DEFAULT_COLLECTIONS = [
  {
    "name": "cities",
    "type": "base",
    "system": false,
    "listRule": "",
    "viewRule": "",
    "createRule": null,
    "updateRule": null,
    "deleteRule": null,
    "schema": [
      {
        "name": "name",
        "type": "text",
        "system": false,
        "required": true,
        "presentable": true,
        "options": {
          "max": 100,
          "min": 1,
          "pattern": "^[a-zA-Z0-9\\s\\-\\.\\,\\']+$"
        }
      },
      {
        "name": "latitude",
        "type": "number",
        "system": false,
        "required": false,
        "presentable": false,
        "options": {
          "min": -90,
          "max": 90,
          "noDecimal": false
        }
      },
      {
        "name": "longitude",
        "type": "number",
        "system": false,
        "required": false,
        "presentable": false,
        "options": {
          "min": -180,
          "max": 180,
          "noDecimal": false
        }
      }
    ]
  },
  {
    "name": "templates",
    "type": "base",
    "system": false,
    "listRule": "",
    "viewRule": "",
    "createRule": null,
    "updateRule": null,
    "deleteRule": null,
    "schema": [
      {
        "name": "name",
        "type": "text",
        "system": false,
        "required": true,
        "presentable": true,
        "options": {
          "max": 100,
          "min": 1,
          "pattern": "^[a-zA-Z0-9_\\-]+$"
        }
      },
      {
        "name": "description",
        "type": "text",
        "system": false,
        "required": false,
        "presentable": false,
        "options": {
          "max": 500,
          "min": 0
        }
      },
      {
        "name": "is_default",
        "type": "bool",
        "system": false,
        "required": false,
        "presentable": false,
        "options": {}
      },
      {
        "name": "version",
        "type": "number",
        "system": false,
        "required": false,
        "presentable": false,
        "options": {
          "min": 1,
          "max": 999,
          "noDecimal": true
        }
      },
      {
        "name": "structure",
        "type": "json",
        "system": false,
        "required": true,
        "presentable": false,
        "options": {}
      }
    ]
  },
  {
    "name": "planners",
    "type": "base",
    "system": false,
    "listRule": "@request.auth.id = user_id",
    "viewRule": "@request.auth.id = user_id",
    "createRule": "@request.auth.id = user_id",
    "updateRule": "@request.auth.id = user_id",
    "deleteRule": "@request.auth.id = user_id",
    "schema": [
      {
        "name": "week_id",
        "type": "text",
        "system": false,
        "required": true,
        "presentable": true,
        "options": {
          "max": 50,
          "min": 1,
          "pattern": "^\\d{4}-W\\d{1,2}$"
        }
      },
      {
        "name": "user_id",
        "type": "relation",
        "system": false,
        "required": true,
        "presentable": false,
        "options": {
          "collectionId": "_users",
          "cascadeDelete": true,
          "minSelect": 1,
          "maxSelect": 1,
          "displayFields": []
        }
      },
      {
        "name": "title",
        "type": "text",
        "system": false,
        "required": false,
        "presentable": false,
        "options": {
          "max": 200,
          "min": 0
        }
      },
      {
        "name": "city",
        "type": "text",
        "system": false,
        "required": false,
        "presentable": false,
        "options": {
          "max": 100,
          "min": 0
        }
      },
      {
        "name": "date_range",
        "type": "text",
        "system": false,
        "required": false,
        "presentable": false,
        "options": {
          "max": 100,
          "min": 0
        }
      },
      {
        "name": "prayer_times",
        "type": "json",
        "system": false,
        "required": false,
        "presentable": false,
        "options": {}
      },
      {
        "name": "schedule_data",
        "type": "json",
        "system": false,
        "required": false,
        "presentable": false,
        "options": {}
      },
      {
        "name": "tasks_data",
        "type": "json",
        "system": false,
        "required": false,
        "presentable": false,
        "options": {}
      },
      {
        "name": "workout_data",
        "type": "json",
        "system": false,
        "required": false,
        "presentable": false,
        "options": {}
      },
      {
        "name": "meals_data",
        "type": "json",
        "system": false,
        "required": false,
        "presentable": false,
        "options": {}
      },
      {
        "name": "grocery_data",
        "type": "json",
        "system": false,
        "required": false,
        "presentable": false,
        "options": {}
      },
      {
        "name": "measurements_data",
        "type": "json",
        "system": false,
        "required": false,
        "presentable": false,
        "options": {}
      },
      {
        "name": "financials_data",
        "type": "json",
        "system": false,
        "required": false,
        "presentable": false,
        "options": {}
      }
    ]
  }
];

const DEFAULT_SEEDS = {
  "cities": [
    {
      "name": "London",
      "latitude": 51.5074,
      "longitude": -0.1278
    },
    {
      "name": "Cairo",
      "latitude": 30.0444,
      "longitude": 31.2357
    },
    {
      "name": "New York",
      "latitude": 40.7128,
      "longitude": -74.0060
    },
    {
      "name": "Tokyo",
      "latitude": 35.6762,
      "longitude": 139.6503
    },
    {
      "name": "Dubai",
      "latitude": 25.2048,
      "longitude": 55.2708
    },
    {
      "name": "Current Location",
      "latitude": null,
      "longitude": null
    }
  ],
  "templates": [
    {
      "name": "enhanced-weekly-v3-strict",
      "description": "Enhanced weekly planner v3 (strict, no fallbacks). This is the primary template with all required fields and complete validation compliance.",
      "is_default": true,
      "version": 3,
      "structure": {
        "ui": {
          "title_default": "My Dynamic Weekly Plan",
          "headers": {
            "main_table": ["TIME", "SECTION", "ACTIVITY/ITEM", "SCORE", "MAX", "STRK"],
            "days": ["MON", "TUE", "WED", "THU", "FRI", "SAT", "SUN"],
            "max_cols": ["Goal", "Goal", "Goal", "Goal", "Goal", "Goal", "Goal"],
            "tasks": ["#", "PRI", "TAG", "TASK/PROJECT DESCRIPTION", "START", "DUE", "DONE", "DELAY", "STATUS"]
          },
          "sections": {
            "tasks": "TASKS & PROJECTS",
            "workout": "WORKOUT REGIMEN",
            "meals": "MEAL PLAN",
            "grocery": "GROCERIES",
            "measurements": "BODY MEASUREMENTS",
            "financials": "FINANCIAL OVERVIEW"
          },
          "placeholders": {
            "task_num_prefix": "",
            "task_priority": "A",
            "task_tag": "WRK",
            "task_description": "Enter task details here...",
            "grocery_budget_value": "100.00",
            "measurement_value": "0",
            "financial_value": "0.00",
            "workout_weight_value": "0",
            "workout_sets_value": "3",
            "workout_reps_value": "10",
            "no_saved_schedules": "No Schedules Found"
          },
          "symbols": {
            "currency_default": "¬£",
            "weight_unit": "kg",
            "sets_reps_separator": "√ó",
            "task_checkbox_empty": "‚òê",
            "task_checkbox_checked": "‚úì",
            "task_delay_ontime": "‚è∞",
            "default_measurement_unit": "cm",
            "time_am": "am",
            "time_pm": "pm"
          }
        },
        "prayer_times": [
          {"label": "Qiyam", "value": ""},
          {"label": "Fajr", "value": ""},
          {"label": "Dhuhr", "value": ""},
          {"label": "Asr", "value": ""},
          {"label": "Maghrib", "value": ""},
          {"label": "Isha", "value": ""}
        ],
        "schedule": [
          {
            "name": "SPIRITUAL",
            "activities": [
              {
                "name": "QURAN: Recitation",
                "max_per_day": 1,
                "max_score": 7
              },
              {
                "name": "PRAYER: Fajr on time",
                "max_per_day": 1,
                "max_score": 7
              },
              {
                "name": "PRAYER: Dhuhr on time",
                "max_per_day": 1,
                "max_score": 7
              },
              {
                "name": "PRAYER: Asr on time",
                "max_per_day": 1,
                "max_score": 7
              },
              {
                "name": "PRAYER: Maghrib on time",
                "max_per_day": 1,
                "max_score": 7
              },
              {
                "name": "PRAYER: Isha on time",
                "max_per_day": 1,
                "max_score": 7
              }
            ]
          },
          {
            "name": "STUDY",
            "activities": [
              {
                "name": "SUBJECT A: 1hr focus",
                "days": ["mon", "wed", "fri"],
                "max_per_day": 1,
                "max_score": 3
              },
              {
                "name": "SUBJECT B: 30min review",
                "days": ["tue", "thu"],
                "max_per_day": 1,
                "max_score": 2
              }
            ]
          },
          {
            "name": "HEALTH",
            "activities": [
              {
                "name": "WORKOUT: Planned session",
                "days": ["mon", "wed", "fri"],
                "max_per_day": 1,
                "max_score": 3
              },
              {
                "name": "HYDRATION: 2L Water",
                "max_per_day": 1,
                "max_score": 7
              }
            ]
          },
          {
            "name": "TOTAL",
            "activities": [
              {
                "name": "DAILY SCORE",
                "max_per_day": 0,
                "max_score": 0
              }
            ]
          }
        ],
        "tasks": {
          "count": 20
        },
        "workout": [
          {
            "name": "MONDAY: Upper Body",
            "exercises": [
              {
                "name": "Bench Press",
                "default_weight": 80,
                "default_sets": 3,
                "default_reps": 8
              },
              {
                "name": "Overhead Press",
                "default_weight": 50,
                "default_sets": 3,
                "default_reps": 10
              },
              {
                "name": "Rows",
                "default_weight": 70,
                "default_sets": 3,
                "default_reps": 10
              }
            ]
          },
          {
            "name": "WEDNESDAY: Lower Body",
            "exercises": [
              {
                "name": "Squats",
                "default_weight": 100,
                "default_sets": 3,
                "default_reps": 8
              },
              {
                "name": "Deadlifts",
                "default_weight": 120,
                "default_sets": 1,
                "default_reps": 5
              },
              {
                "name": "Leg Press",
                "default_weight": 150,
                "default_sets": 3,
                "default_reps": 12
              }
            ]
          },
          {
            "name": "FRIDAY: Full Body/Cardio",
            "exercises": [
              {
                "name": "Pull-ups",
                "default_weight": 0,
                "default_sets": 3,
                "default_reps": 10
              },
              {
                "name": "Dips",
                "default_weight": 0,
                "default_sets": 3,
                "default_reps": 12
              },
              {
                "name": "Running",
                "default_weight": 0,
                "default_sets": 1,
                "default_reps": 30
              }
            ]
          }
        ],
        "meals": [
          {
            "name": "Breakfast",
            "ingredients": "Oats, Berries, Protein Powder, Nuts"
          },
          {
            "name": "Lunch",
            "ingredients": "Grilled Chicken Salad with Mixed Greens, Whole Wheat Bread/Quinoa"
          },
          {
            "name": "Dinner",
            "ingredients": "Baked Salmon, Steamed Asparagus, Sweet Potato"
          },
          {
            "name": "Snack 1",
            "ingredients": "Greek Yogurt with Honey"
          },
          {
            "name": "Snack 2",
            "ingredients": "Apple with Almond Butter"
          }
        ],
        "grocery": {
          "budget_default": "120",
          "categories": [
            {
              "name": "Protein",
              "items": "Chicken Breast, Salmon Fillets, Eggs, Tofu, Greek Yogurt, Protein Powder"
            },
            {
              "name": "Carbs & Grains",
              "items": "Oats, Quinoa, Brown Rice, Sweet Potatoes, Whole Wheat Bread"
            },
            {
              "name": "Fats",
              "items": "Avocado, Almonds, Walnuts, Olive Oil, Almond Butter"
            },
            {
              "name": "Fruits & Veg",
              "items": "Broccoli, Spinach, Berries, Apples, Asparagus, Mixed Greens"
            },
            {
              "name": "Dairy/Alternatives",
              "items": "Milk (or Almond/Soy Milk)"
            },
            {
              "name": "Other",
              "items": "Honey, Coffee, Tea"
            }
          ]
        },
        "measurements": [
          {
            "name": "Weight",
            "placeholder": "75",
            "unit": "kg"
          },
          {
            "name": "Waist Circ.",
            "placeholder": "80",
            "unit": "cm"
          },
          {
            "name": "Body Fat %",
            "placeholder": "15",
            "unit": "%"
          }
        ],
        "financials": [
          {
            "name": "Monthly Salary",
            "placeholder": "3000",
            "account": "Main Bank Acc",
            "currency_symbol": "¬£"
          },
          {
            "name": "Rent/Mortgage",
            "placeholder": "900",
            "account": "Main Bank Acc",
            "currency_symbol": "¬£"
          },
          {
            "name": "Utilities",
            "placeholder": "150",
            "account": "Main Bank Acc",
            "currency_symbol": "¬£"
          },
          {
            "name": "Investments",
            "placeholder": "250",
            "account": "Brokerage Acc",
            "currency_symbol": "$"
          },
          {
            "name": "Savings Goal",
            "placeholder": "500",
            "account": "Savings Acc",
            "currency_symbol": "¬£"
          }
        ],
        "city_default": "London"
      }
    }
  ]
};

// Event handlers
document.getElementById('togglePass').onclick = () => {
    const passInput = document.getElementById('pass');
    const toggleBtn = document.getElementById('togglePass');
    if (passInput.type === 'password') {
        passInput.type = 'text';
        toggleBtn.textContent = 'üôà';
        toggleBtn.title = 'Hide password';
    } else {
        passInput.type = 'password';
        toggleBtn.textContent = 'üëÅÔ∏è';
        toggleBtn.title = 'Show password';
    }
};

document.getElementById('health').onclick = healthCheck;

document.getElementById('setup').onclick = async () => {
    out.innerHTML = '';
    if (await healthCheck()) {
        log("Health check passed. Starting full setup...", "i");
        if (await runSchema() && await runSeed() && await runValidate()) {
            log('üéâ Full setup completed successfully! Your A4 Planner is ready to use.', 's');
        } else {
            log('‚ùå Full setup failed. Check the error messages above.', 'e');
        }
    } else {
        log("‚ùå Health check failed. Cannot proceed with setup.", "e");
    }
};

document.getElementById('schema').onclick = async () => {
    out.innerHTML = '';
    if (await healthCheck()) await runSchema();
};

document.getElementById('seed').onclick = async () => {
    out.innerHTML = '';
    if (await healthCheck()) await runSeed();
};

document.getElementById('validate').onclick = async () => {
    out.innerHTML = '';
    if (await healthCheck()) await runValidate();
};

document.getElementById('reset').onclick = async () => {
    if (await healthCheck()) await resetAll();
};

document.getElementById('export').onclick = () => {
    const config = {
        url: document.getElementById('url').value,
        email: document.getElementById('email').value,
        collections: validateJSON(collEditor.value).data,
        seeds: validateJSON(seedEditor.value).data
    };
    
    const blob = new Blob([JSON.stringify(config, null, 2)], {type: 'application/json'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'pocketbase-config.json';
    link.click();
    URL.revokeObjectURL(link.href);
    log('‚úÖ Configuration exported successfully', 's');
};

document.getElementById('import').onclick = () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const config = JSON.parse(e.target.result);
                if (config.url) document.getElementById('url').value = config.url;
                if (config.email) document.getElementById('email').value = config.email;
                if (config.collections) collEditor.value = JSON.stringify(config.collections, null, 2);
                if (config.seeds) seedEditor.value = JSON.stringify(config.seeds, null, 2);
                updateStats();
                log('‚úÖ Configuration imported successfully', 's');
            } catch (e) {
                log(`‚ùå Import error: ${e.message}`, 'e');
            }
        };
        reader.readAsText(file);
    };
    input.click();
};

// Initialize with defaults
collEditor.value = JSON.stringify(DEFAULT_COLLECTIONS, null, 2);
seedEditor.value = JSON.stringify(DEFAULT_SEEDS, null, 2);
updateStats();

log("üöÄ PocketBase setup tool loaded with bulletproof configurations", "i");
log("üí° Click 'Test Connection' to verify your PocketBase instance, then 'Full Setup' to configure everything", "i");
</script>
</body>
</html>
