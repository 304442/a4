<!DOCTYPE html>
<html>
<head>
    <title>PocketBase Connection Test</title>
</head>
<body>
    <h1>PocketBase Connection Test</h1>
    <div id="status">Testing...</div>
    <div id="error" style="color: red;"></div>
    
    <script src="pocketbase.umd.js"></script>
    <script>
        async function testConnection() {
            const statusEl = document.getElementById('status');
            const errorEl = document.getElementById('error');
            
            try {
                // Test 1: Initialize PocketBase
                statusEl.innerHTML += '<br>1. Initializing PocketBase...';
                const pb = new PocketBase(window.location.origin);
                
                // Test 2: Check health
                statusEl.innerHTML += '<br>2. Checking API health...';
                const response = await fetch(window.location.origin + '/api/health');
                const health = await response.json();
                statusEl.innerHTML += '<br>✅ API Health: ' + JSON.stringify(health);
                
                // Test 3: Try to fetch templates
                statusEl.innerHTML += '<br>3. Fetching templates...';
                try {
                    const templates = await pb.collection('templates').getList(1, 50);
                    statusEl.innerHTML += '<br>✅ Templates found: ' + templates.items.length;
                } catch (e) {
                    statusEl.innerHTML += '<br>❌ Templates error: ' + e.message;
                }
                
                // Test 4: Check localStorage
                statusEl.innerHTML += '<br>4. Testing localStorage...';
                localStorage.setItem('test', 'works');
                const testValue = localStorage.getItem('test');
                statusEl.innerHTML += '<br>✅ localStorage: ' + (testValue === 'works' ? 'Working' : 'Failed');
                
                // Test 5: Check current week
                const currentWeek = new Date().toISOString().split('T')[0];
                const weekNum = getWeekNumber(new Date());
                const weekId = `${new Date().getFullYear()}-W${weekNum.toString().padStart(2, '0')}`;
                statusEl.innerHTML += '<br>5. Current week: ' + weekId;
                
            } catch (error) {
                errorEl.innerHTML = 'Error: ' + error.message + '<br>Stack: ' + error.stack;
            }
        }
        
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            return weekNo;
        }
        
        // Run test on load
        testConnection();
    </script>
</body>
</html>