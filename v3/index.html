<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=210mm, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>A4 Planner</title>
  <script src="pocketbase.umd.js"></script> 
  <script defer src="script.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.9/dist/cdn.min.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body x-data="plannerApp()" x-init="init()">
  <div id="save-status" :class="'status-' + saveStatus" x-text="saveStatus === 'saving' ? 'Saving...' : (saveStatus === 'error' ? 'Error saving!' : 'Saved')"></div>
  <div id="sync-status" :class="pendingSync.length > 0 ? 'status-pending' : 'status-synced'" x-show="pendingSync.length > 0 || isOnline === false">
    <span x-text="isOnline ? (pendingSync.length > 0 ? 'Pending sync: ' + pendingSync.length : '') : 'Offline mode'"></span>
  </div>
  <div id="notification" :class="{ 'show': showNotification }" x-text="notificationMessage"></div>

  <div class="card">
    <div class="flex between center mb-1">
      <h1 class="text-sm bold editable" @dblclick="editInline($event, 'plannerTitle', null, plannerTitle)" x-text="plannerTitle || 'Planner'"></h1>
      <div class="flex center text-xs">
        <template x-for="(time, i) in times" :key="time.label + i">
          <div class="flex center">
            <span class="editable" @dblclick="editInline($event, 'timeLabel', i, time.label)" x-text="(time.label || 'T') + ':'"></span>
            <input type="text" class="mini-input time-value-input" x-model="time.value" @change="saveData()">
          </div>
        </template>
      </div>
      <div class="text-sm">
        <span class="clickable" x-text="currentWeek" @click="toggleWeekSelector($event)"></span> (<span x-text="dateRange"></span>)
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:18mm" class="editable" @dblclick="editInline($event, 'mainTableHeader', 0, uiConfig.mainTableHeaders ? uiConfig.mainTableHeaders[0] : 'TIME')" x-text="uiConfig.mainTableHeaders ? uiConfig.mainTableHeaders[0] : 'TIME'"></th>
          <th style="width:18mm" class="editable" @dblclick="editInline($event, 'mainTableHeader', 1, uiConfig.mainTableHeaders ? uiConfig.mainTableHeaders[1] : 'DAY')" x-text="uiConfig.mainTableHeaders ? uiConfig.mainTableHeaders[1] : 'DAY'"></th>
          <th class="ac editable" @dblclick="editInline($event, 'mainTableHeader', 2, uiConfig.mainTableHeaders ? uiConfig.mainTableHeaders[2] : 'ACTIVITY')" x-text="uiConfig.mainTableHeaders ? uiConfig.mainTableHeaders[2] : 'ACTIVITY'"></th>
          <template x-for="(dayKey, i) in ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN']" :key="dayKey">
            <th class="dc editable" :class="{'current-day': i === (currentDay === 0 ? 6 : currentDay - 1)}" @dblclick="editInline($event, 'dayHeader', i, uiConfig.dayHeaders ? uiConfig.dayHeaders[i] : dayKey)" x-text="uiConfig.dayHeaders ? uiConfig.dayHeaders[i] : dayKey"></th>
            <th class="dc editable" :class="{'current-day': i === (currentDay === 0 ? 6 : currentDay - 1)}" @dblclick="editInline($event, 'maxHeader', i, uiConfig.maxHeaders ? uiConfig.maxHeaders[i] : 'MAX')" x-text="uiConfig.maxHeaders ? uiConfig.maxHeaders[i] : 'MAX'"></th>
          </template>
          <th class="dc editable" @dblclick="editInline($event, 'mainTableHeader', 3, uiConfig.mainTableHeaders ? uiConfig.mainTableHeaders[3] : 'SCR')" x-text="uiConfig.mainTableHeaders ? uiConfig.mainTableHeaders[3] : 'SCR'"></th>
          <th class="dc editable" @dblclick="editInline($event, 'mainTableHeader', 4, uiConfig.mainTableHeaders ? uiConfig.mainTableHeaders[4] : 'MAX')" x-text="uiConfig.mainTableHeaders ? uiConfig.mainTableHeaders[4] : 'MAX'"></th>
          <th class="dc editable" @dblclick="editInline($event, 'mainTableHeader', 5, uiConfig.mainTableHeaders ? uiConfig.mainTableHeaders[5] : 'ðŸ”¥')" x-text="uiConfig.mainTableHeaders ? uiConfig.mainTableHeaders[5] : 'ðŸ”¥'"></th>
        </tr>
      </thead>
      <tbody>
        <template x-for="(section, sIdxOriginal) in schedule.slice().reverse()" :key="section.id || section.name + sIdxOriginal">
          <template x-for="(activity, aIdx) in section.activities" :key="activity.id || activity.name + aIdx">
            <tr :class="{'total': section.name === 'TOTAL'}">
              <td class="bold editable" x-show="aIdx === 0" :rowspan="section.activities.length" @dblclick="editInline($event, 'sectionName', schedule.length - 1 - sIdxOriginal, section.name)" x-text="section.name"></td>
               <td class="bold editable" @dblclick="editInline($event, 'activityPrefix', {sIdx: schedule.length - 1 - sIdxOriginal, aIdx}, activity.name.includes(':') ? activity.name.split(':')[0].trim() : '')" x-text="activity.name.includes(':') ? activity.name.split(':')[0] : ''"></td>
              <td class="ac editable" @dblclick="editInline($event, 'activityName', {sIdx: schedule.length - 1 - sIdxOriginal, aIdx}, activity.name.includes(':') ? activity.name.split(':')[1].trim() : activity.name)">
                <span x-text="activity.name.includes(':') ? activity.name.split(':')[1].trim() : activity.name"></span>
              </td>
              <template x-for="(dayKey, dayIdx) in ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun']" :key="dayKey">
                <td class="dc" :class="{'current-day': dayIdx === (currentDay === 0 ? 6 : currentDay - 1)}">
                  <template x-if="activity.days && activity.days[dayKey]">
                    <input type="number" class="mini-input" x-model.number="activity.days[dayKey].value" :min="0" :max="activity.days[dayKey].max < 10 ? 9 : 99" @change="validateNumberInput($event)" :readonly="section.name === 'TOTAL'">
                  </template>
                </td>
                <td class="dc editable" :class="{'current-day': dayIdx === (currentDay === 0 ? 6 : currentDay - 1)}" @dblclick="editInline($event, 'maxValue', {sIdx: schedule.length - 1 - sIdxOriginal, aIdx, day: dayKey}, activity.days[dayKey]?.max || '')" x-text="activity.days[dayKey]?.max || ''"></td>
              </template>
              <td class="dc" :class="{ 'score-low': activity.maxScore > 0 && (activity.score / activity.maxScore) < 0.33, 'score-medium': activity.maxScore > 0 && (activity.score / activity.maxScore) >= 0.33 && (activity.score / activity.maxScore) < 0.66, 'score-high': activity.maxScore > 0 && (activity.score / activity.maxScore) >= 0.66 }">
                <input type="number" class="mini-input" x-model.number="activity.score" readonly>
              </td>
              <td class="dc editable" @dblclick="editInline($event, 'maxScore', {sIdx: schedule.length - 1 - sIdxOriginal, aIdx}, activity.maxScore)" x-text="activity.maxScore"></td>
              <td class="dc streak-cell" :class="{'has-streak': activity.streaks?.current > 2}">
                <span x-text="activity.streaks?.current > 0 ? activity.streaks.current : ''"></span>
              </td>
            </tr>
          </template>
          <tr x-if="section.name === 'TOTAL' && section.activities.length > 0 && section.activities[0].maxScore > 0">
            <td :colspan="3"></td> 
            <td colspan="16" class="progress-container"> 
              <div class="progress-bar" :style="`width: ${Math.min(100, (section.activities[0].score / section.activities[0].maxScore) * 100)}%;`" :class="{ 'progress-low': (section.activities[0].score / section.activities[0].maxScore) < 0.33, 'progress-medium': (section.activities[0].score / section.activities[0].maxScore) >= 0.33 && (section.activities[0].score / section.activities[0].maxScore) < 0.66, 'progress-high': (section.activities[0].score / section.activities[0].maxScore) >= 0.66 }"></div>
            </td>
          </tr>
        </template>
      </tbody>
    </table>

    <div class="section">
      <div class="section-header">
        <h3 class="section-title editable" @dblclick="editInline($event, 'sectionTitle', 'tasks', uiConfig.sectionTitles?.tasks || 'TASKS')" x-text="uiConfig.sectionTitles?.tasks || 'TASKS & NOTES'"></h3>
      </div>
      <table>
        <thead>
          <tr>
            <th style="width:5mm" class="editable" @dblclick="editInline($event, 'taskHeader', 0, uiConfig.taskHeaders?.[0] || 'â„–')" x-text="uiConfig.taskHeaders?.[0] || 'â„–'"></th>
            <th style="width:5mm" class="editable" @dblclick="editInline($event, 'taskHeader', 1, uiConfig.taskHeaders?.[1] || 'ðŸ”¥')" x-text="uiConfig.taskHeaders?.[1] || 'ðŸ”¥'"></th>
            <th style="width:5mm" class="editable" @dblclick="editInline($event, 'taskHeader', 2, uiConfig.taskHeaders?.[2] || 'ðŸ·ï¸')" x-text="uiConfig.taskHeaders?.[2] || 'ðŸ·ï¸'"></th>
            <th style="text-align:left" class="editable" @dblclick="editInline($event, 'taskHeader', 3, uiConfig.taskHeaders?.[3] || 'âœï¸ Task')" x-text="uiConfig.taskHeaders?.[3] || 'âœï¸ Task/Event/Note'"></th>
            <th style="width:10mm" class="editable" @dblclick="editInline($event, 'taskHeader', 4, uiConfig.taskHeaders?.[4] || 'ðŸ“…')" x-text="uiConfig.taskHeaders?.[4] || 'ðŸ“…'"></th>
            <th style="width:5mm" class="editable" @dblclick="editInline($event, 'taskHeader', 5, uiConfig.taskHeaders?.[5] || 'âœ“')" x-text="uiConfig.taskHeaders?.[5] || 'âœ“'"></th>
          </tr>
        </thead>
        <tbody>
          <template x-for="(task, i) in tasks" :key="task.id || i">
            <tr :class="{'task-completed': task.completed === 'âœ“'}">
              <td><input type="text" class="mini-input" x-model="task.num" :placeholder="i + 1" @change="validateTextInput($event)"></td>
              <td><input type="text" class="mini-input" x-model="task.priority" placeholder="A" @change="validateTextInput($event)"></td>
              <td><input type="text" class="mini-input" x-model="task.tag" placeholder="W" @change="validateTextInput($event)"></td>
              <td><input type="text" class="mini-input task-description-input" x-model="task.description" placeholder="Task description" @change="validateTextInput($event)"></td>
              <td><input type="text" class="mini-input" x-model="task.date" :placeholder="DateTimeUtils.formatShortDate(i)" @change="validateTextInput($event)"></td>
              <td><input type="text" class="mini-input" x-model="task.completed" @click.prevent="toggleTaskCompletion(task)" :class="{'completed-task': task.completed === 'âœ“'}" placeholder="â˜"></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <div class="section">
      <div class="section-header">
        <h3 class="section-title editable" @dblclick="editInline($event, 'sectionTitle', 'workout', uiConfig.sectionTitles?.workout || 'WORKOUT')" x-text="uiConfig.sectionTitles?.workout || 'WORKOUT PLAN'"></h3>
      </div>
      <div class="grid">
        <template x-for="(day, dayIdx) in workoutPlan" :key="day.id || dayIdx">
          <div class="p-1 workout-day-card">
            <div class="workout-day-header">
                <p class="bold text-center mb-1 editable workout-day-name" @dblclick="editInline($event, 'workoutDayName', dayIdx, day.name)" x-text="day.name"></p>
            </div>
            <template x-for="(ex, exIdx) in day.exercises" :key="ex.id || exIdx">
              <div class="exercise">
                <div class="exercise-name editable" :title="ex.prefix + ex.name" @dblclick="editInline($event, 'exerciseName', {dayIdx, exIdx}, ex.name)">
                  <span class="editable" @dblclick.stop="editInline($event, 'exercisePrefix', {dayIdx, exIdx}, ex.prefix)" x-text="ex.prefix"></span>
                  <span x-text="ex.name"></span>:
                </div>
                <div class="exercise-inputs">
                  <input type="number" class="mini-input" x-model.number="ex.weight" @change="validateNumberInput($event)" :placeholder="ex.defaultWeight">
                  <span class="exercise-unit">kg,</span>
                  <input type="number" class="mini-input sets" x-model.number="ex.sets" @change="validateNumberInput($event)" :placeholder="ex.defaultSets">
                  <span class="exercise-unit">Ã—</span>
                  <input type="number" class="mini-input reps" x-model.number="ex.reps" @change="validateNumberInput($event)" :placeholder="ex.defaultReps">
                </div>
              </div>
            </template>
          </div>
        </template>
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <h3 class="section-title editable" @dblclick="editInline($event, 'sectionTitle', 'meals', uiConfig.sectionTitles?.meals || 'MEALS')" x-text="uiConfig.sectionTitles?.meals || 'MEAL PREP'"></h3>
      </div>
      <ul class="list text-xs">
        <template x-for="(meal, i) in meals" :key="meal.id || i">
          <li class="list-item">
            <div>
                <span class="bold editable" @dblclick="editInline($event, 'mealName', i, meal.name)" x-text="meal.name + ':'"></span>
                <span class="editable" @dblclick="editInline($event, 'mealIngredients', i, meal.ingredients)" x-text="meal.ingredients"></span>
            </div>
          </li>
        </template>
      </ul>
    </div>

    <div class="section">
      <div class="section-header">
        <h3 class="section-title editable" @dblclick="editInline($event, 'sectionTitle', 'grocery', uiConfig.sectionTitles?.grocery || 'GROCERIES')">
            <span x-text="uiConfig.sectionTitles?.grocery || 'GROCERY LIST'"></span>
            <input type="text" class="mini-input grocery-budget-input" x-model="groceryBudget" :placeholder="appDefaults?.grocery_budget_default_placeholder || 'Â£0'" @change="validateTextInput($event)">
        </h3>
      </div>
      <ul class="list text-xs">
        <template x-for="(cat, i) in groceryList" :key="cat.id || i">
          <li class="list-item">
            <div>
                <span class="bold editable" @dblclick="editInline($event, 'groceryCategoryName', i, cat.name)" x-text="cat.name + ':'"></span>
                <span class="editable" @dblclick="editInline($event, 'groceryCategoryItems', i, cat.items)" x-text="cat.items"></span>
            </div>
          </li>
        </template>
      </ul>
    </div>

    <div class="section">
      <div class="section-header">
        <h3 class="section-title editable" @dblclick="editInline($event, 'sectionTitle', 'measurements', uiConfig.sectionTitles?.measurements || 'MEASUREMENTS')" x-text="uiConfig.sectionTitles?.measurements || 'BODY MEASUREMENTS'"></h3>
      </div>
      <div class="form-row text-xs">
        <template x-for="(m, i) in bodyMeasurements" :key="m.id || i">
          <div class="form-field">
            <span class="form-label editable" @dblclick="editInline($event, 'measurementName', i, m.name)" x-text="m.name + ':'"></span>
            <input type="text" class="mini-input measurement-value-input" x-model="m.value" :placeholder="m.placeholder" @change="validateTextInput($event)">
          </div>
        </template>
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <h3 class="section-title editable" @dblclick="editInline($event, 'sectionTitle', 'financials', uiConfig.sectionTitles?.financials || 'FINANCIALS')" x-text="uiConfig.sectionTitles?.financials || 'MONTH/1ST: FINANCIAL'"></h3>
      </div>
      <div class="form-row text-xs">
        <template x-for="(item, i) in financials" :key="item.id || i">
          <div class="form-field">
            <span class="form-label editable" @dblclick="editInline($event, 'financialName', i, item.name)" x-text="item.name + ':'"></span>
            Â£<input type="text" class="mini-input financial-value-input" x-model="item.value" :placeholder="item.placeholder" @change="validateTextInput($event)">
            <span class="editable" @dblclick="editInline($event, 'financialAccount', i, item.account)" x-text="item.account"></span>
          </div>
        </template>
      </div>
    </div>
  </div>

  <div class="dropdown" :class="{'show': showWeekSelector}" :style="`top: ${dropdownPosition.top}px; left: ${dropdownPosition.left}px;`">
    <div class="dropdown-content">
      <template x-if="savedWeeks.length > 0">
        <template x-for="week in savedWeeks" :key="week.iso_week">
          <div class="flex between center dropdown-item" :class="{'current': week.isCurrent}">
            <span @click="confirmLoadWeek(week.iso_week)" x-text="`${week.iso_week} (${week.dateRange})`"></span>
            <span @click="confirmDeleteWeek(week.iso_week)" class="delete-week-btn">Ã—</span>
          </div>
        </template>
      </template>
      <template x-if="savedWeeks.length === 0">
        <div class="dropdown-item-empty">No saved schedules found</div>
      </template>
    </div>
  </div>
</body>
</html>
