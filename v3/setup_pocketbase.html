<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PocketBase Setup Utility</title>
    <script src="pocketbase.umd.js"></script> <!-- Make sure this path is correct -->
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
        .container { max-width: 600px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
        label { display: block; margin-bottom: 5px; }
        input[type="text"], input[type="password"], input[type="url"] { width: 95%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 3px; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        pre { background-color: #f4f4f4; padding: 10px; border: 1px solid #eee; white-space: pre-wrap; word-wrap: break-word; max-height: 300px; overflow-y: auto; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <div class="container">
        <h1>PocketBase Initial Setup Utility</h1>
        <p>This utility will attempt to create the necessary collections ('planners', 'app_config') and seed default configuration data into your PocketBase instance. <strong>Use with caution and only on a fresh or development instance.</strong></p>
        
        <div>
            <label for="pb_url">PocketBase URL (e.g., http://127.0.0.1:8090):</label>
            <input type="url" id="pb_url" value="http://127.0.0.1:8090">
        </div>
        <div>
            <label for="admin_email">Admin Email:</label>
            <input type="text" id="admin_email" placeholder="your-admin-email@example.com">
        </div>
        <div>
            <label for="admin_password">Admin Password:</label>
            <input type="password" id="admin_password">
        </div>
        <button onclick="runSetup()">Run Setup / Seed Database</button>

        <hr style="margin: 20px 0;">
        <h3>Log:</h3>
        <pre id="logOutput">Setup log will appear here...</pre>
    </div>

    <script>
        const logElement = document.getElementById('logOutput');

        function log(message, type = 'info') {
            const line = document.createElement('div');
            line.textContent = `[${type.toUpperCase()}] ${new Date().toLocaleTimeString()}: ${message}`;
            if (type === 'error') line.style.color = 'red';
            if (type === 'success') line.style.color = 'green';
            logElement.appendChild(line);
            logElement.scrollTop = logElement.scrollHeight;
            console[type === 'error' ? 'error' : 'log'](message);
        }
        
        function generateSeedId(prefix = 'seed_') { 
            return prefix + Date.now().toString(36).slice(-3) + Math.random().toString(36).substr(2, 3);
        }

        // --- SCHEMA DEFINITIONS (for pb.collections.create) ---
        const plannersCollectionSchema = {
            name: "planners", type: "base", system: false, listRule: "", viewRule: "", createRule: "", updateRule: "", deleteRule: "", options: {},
            schema: [
                 { name: "user", type: "relation", system: false, required: false, options: { collectionId: "users", cascadeDelete: false, minSelect: null, maxSelect: 1 }},
                { name: "week_id", type: "text", system: false, required: true, unique: true, presentable: true, options: { pattern: "^\\d{4}-W(0[1-9]|[1-4][0-9]|5[0-3])$"}},
                { name: "date_range", type: "text", system: false, required: false, options: {}},
                { name: "planner_title", type: "text", system: false, required: false, presentable: true, options: {}},
                { name: "ui_config", type: "json", system: false, required: false, options: {maxSize:524288}},
                { name: "times_display", type: "json", system: false, required: false, options: {maxSize:10240}},
                { name: "schedule_data", type: "json", system: false, required: false, options: {maxSize:2097152}},
                { name: "tasks_data", type: "json", system: false, required: false, options: {maxSize:1048576}},
                { name: "workout_plan_data", type: "json", system: false, required: false, options: {maxSize:524288}},
                { name: "meals_data", type: "json", system: false, required: false, options: {maxSize:524288}},
                { name: "grocery_budget", type: "text", system: false, required: false, options: {}},
                { name: "grocery_list_data", type: "json", system: false, required: false, options: {maxSize:524288}},
                { name: "body_measurements_data", type: "json", system: false, required: false, options: {maxSize":524288}},
                { name: "financials_data", type: "json", system: false, required: false, options: {maxSize":524288}}
            ]
        };
        const appConfigCollectionSchema = {
            name: "app_config", type: "base", system: false, listRule: "", viewRule: "", createRule: "@request.auth.admin = true", updateRule: "@request.auth.admin = true", deleteRule: "@request.auth.admin = true", options: {},
            schema: [
              { name: "config_key", type: "text", system: false, required: true, unique: true, presentable: true, options: {min:1, pattern:"default_v[0-9]+"}},
              { name: "planner_title_default", type: "text", system: false, required: false, options: {}},
              { name: "ui_config_default", type: "json", system: false, required: false, options: {maxSize:524288}},
              { name: "times_default", type: "json", system: false, required: false, options: {maxSize:10240}},
              { name: "schedule_default", type: "json", system: false, required: false, options: {maxSize:2097152}},
              { name: "tasks_default_count", type: "number", system: false, required: false, options: {min:0,max:100,noDecimal:true}},
              { name: "workout_plan_default", type: "json", system: false, required: false, options: {maxSize:524288}},
              { name: "meals_default", type: "json", system: false, required: false, options: {maxSize":524288}},
              { name: "grocery_list_default", type: "json", system: false, required: false, options: {maxSize":524288}},
              { name: "grocery_budget_default_placeholder", type: "text", system: false, required: false, options: {}},
              { name: "body_measurements_default", type: "json", system: false, required: false, options: {maxSize":524288}},
              { name: "financials_default", type: "json", system: false, required: false, options: {maxSize":524288}}
            ]
        };

        // --- FULL SEED DATA (From your original script.js - PASTE YOUR ACTUAL DATA HERE) ---
        const SEED_APP_CONFIG_RECORD_DATA = {
            config_key: "default_v1",
            planner_title_default: "Weekly Planner (Seeded via HTML)",
            ui_config_default: { mainTableHeaders: ['TIME', 'DAY', 'ACTIVITY', 'SCR', 'MAX', 'ðŸ”¥'], dayHeaders: ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'], maxHeaders: Array(7).fill('MAX'), taskHeaders: ['â„–', 'ðŸ”¥', 'ðŸ·ï¸', 'âœï¸ Task/Event/Note', 'ðŸ“…', 'âœ“'], sectionTitles: { tasks: 'TASKS & NOTES', workout: 'WORKOUT PLAN', meals: 'MEAL PREP', grocery: 'GROCERY LIST', measurements: 'BODY MEASUREMENTS', financials: 'MONTH/1ST: FINANCIAL'} },
            times_default: [ { label: 'Q', value: '' }, { label: 'F', value: '' }, { label: 'D', value: '' }, { label: 'A', value: '' }, { label: 'M', value: '' }, { label: 'I', value: '' } ],
            schedule_default: [ /* PASTE YOUR FULL DEFAULT SCHEDULE ARRAY HERE. Example: */ { name: 'QIYAM', id: generateSeedId('sec_'), activities: [ { id: generateSeedId('act_'), name: 'DAILY: Wakeup early', days: { mon: { value: '', max: 1 }, tue: { value: '', max: 1 }, wed: { value: '', max: 1 }, thu: { value: '', max: 1 }, fri: { value: '', max: 1 }, sat: { value: '', max: 1 }, sun: { value: '', max: 1 } }, score: 0, maxScore: 7, streaks: { mon:0, tue:0, wed:0, thu:0, fri:0, sat:0, sun:0, current:0, longest:0 }} ]}, { name: 'TOTAL', id: generateSeedId('sec_'), activities: [ { id: generateSeedId('act_'), name: 'DAILY POINTS', days: { mon: { value: '0', max: 0 }, tue: { value: '0', max: 0 }, wed: { value: '0', max: 0 }, thu: { value: '0', max: 0 }, fri: { value: '0', max: 0 }, sat: { value: '0', max: 0 }, sun: { value: '0', max: 0 } }, score: 0, maxScore: 0, streaks: { mon:0, tue:0, wed:0, thu:0, fri:0, sat:0, sun:0, current:0, longest:0 }} ]} ],
            tasks_default_count: 20,
            workout_plan_default: [ /* PASTE YOUR FULL DEFAULT WORKOUT PLAN ARRAY HERE */ ],
            meals_default: [ /* PASTE YOUR FULL DEFAULT MEALS ARRAY HERE */ ],
            grocery_list_default: [ /* PASTE YOUR FULL DEFAULT GROCERY LIST ARRAY HERE */ ],
            grocery_budget_default_placeholder: "Â£120",
            body_measurements_default: [ /* PASTE YOUR FULL DEFAULT BODY MEASUREMENTS ARRAY HERE */ ],
            financials_default: [ /* PASTE YOUR FULL DEFAULT FINANCIALS ARRAY HERE */ ]
        };
        // --- End of Seed Data ---

        async function runSetup() {
            logElement.innerHTML = 'Setup log will appear here...';
            log("Setup process started...");

            const pbUrl = document.getElementById('pb_url').value;
            const adminEmail = document.getElementById('admin_email').value;
            const adminPassword = document.getElementById('admin_password').value;

            if (!pbUrl || !adminEmail || !adminPassword) {
                log("PocketBase URL, Admin Email, and Admin Password are required.", "error");
                alert("PocketBase URL, Admin Email, and Admin Password are required.");
                return;
            }

            const pb = new PocketBase(pbUrl);
            let success = false;

            try {
                log("Attempting admin authentication...");
                await pb.admins.authWithPassword(adminEmail, adminPassword);
                log("Admin authentication successful.", "success");

                // 1. Ensure 'users' collection exists if plannersSchema refers to it
                try {
                    await pb.collections.getOne("users"); // PocketBase default user collection
                    log("'users' collection (system) found.", "info");
                } catch (e) {
                     if (e.status === 404) {
                        log("'users' collection not found. If you intend to use the 'user' field in 'planners', enable Email/Password authentication in PocketBase Admin UI first. The 'user' field in 'planners' will be skipped for now.", "warn");
                        plannersCollectionSchema.schema = plannersCollectionSchema.schema.filter(f => f.name !== 'user');
                    } else {
                         log(`Error checking for 'users' collection: ${e.message}`, "error");
                    }
                }

                // 2. Create/Ensure 'planners' collection
                try {
                    await pb.collections.getOne(plannersCollectionSchema.name);
                    log(`Collection '${plannersCollectionSchema.name}' already exists.`, "info");
                } catch (e) {
                    if (e.status === 404) {
                        log(`Collection '${plannersCollectionSchema.name}' not found, creating...`, "info");
                        await pb.collections.create(plannersCollectionSchema);
                        log(`Collection '${plannersCollectionSchema.name}' created successfully.`, "success");
                    } else { throw new Error(`Error with collection '${plannersCollectionSchema.name}': ${e.message}`); }
                }

                // 3. Create/Ensure 'app_config' collection
                try {
                    await pb.collections.getOne(appConfigCollectionSchema.name);
                    log(`Collection '${appConfigCollectionSchema.name}' already exists.`, "info");
                } catch (e) {
                    if (e.status === 404) {
                        log(`Collection '${appConfigCollectionSchema.name}' not found, creating...`, "info");
                        await pb.collections.create(appConfigCollectionSchema);
                        log(`Collection '${appConfigCollectionSchema.name}' created successfully.`, "success");
                    } else { throw new Error(`Error with collection '${appConfigCollectionSchema.name}': ${e.message}`); }
                }

                // 4. Seed/Update the 'app_config' record
                let existingConfigRecord = null;
                try {
                    existingConfigRecord = await pb.collection('app_config').getFirstListItem(`config_key="${SEED_APP_CONFIG_RECORD_DATA.config_key}"`);
                } catch (e) { if (e.status !== 404) throw e; }

                if (existingConfigRecord) {
                    await pb.collection('app_config').update(existingConfigRecord.id, SEED_APP_CONFIG_RECORD_DATA);
                    log(`Updated app_config record: ${SEED_APP_CONFIG_RECORD_DATA.config_key}`, "success");
                } else {
                    await pb.collection('app_config').create(SEED_APP_CONFIG_RECORD_DATA);
                    log(`Created new app_config record: ${SEED_APP_CONFIG_RECORD_DATA.config_key}`, "success");
                }
                
                log("---------------------------------------------------------", "info");
                log("DATABASE SETUP AND SEEDING COMPLETED SUCCESSFULLY!", "success");
                log("You can now close this utility page and use your main application.", "info");
                log("---------------------------------------------------------", "info");
                alert("Database setup and seeding completed successfully!");
                success = true;

            } catch (error) {
                log(`SETUP/SEEDING FAILED: ${error.message}`, "error");
                if (error.data && Object.keys(error.data).length > 0) { 
                    log(`Error details: ${JSON.stringify(error.data)}`, "error");
                } else if (error.originalError) {
                     log(`Original error: ${error.originalError}`, "error");
                }
                alert(`Database setup/seeding failed: ${error.message}. Check console for details.`);
            } finally {
                pb.authStore.clear(); 
                log("Admin session cleared.", "info");
                if (success) { // Only set session flag and clean URL if all operations were successful
                    sessionStorage.setItem('db_setup_utility_completed_successfully', 'true');
                    const currentUrl = new URL(window.location.href);
                    // No specific seed param to remove for this version, as it's run on demand
                }
            }
        }
        // Make runSetup globally available for the button's onclick
        window.runSetup = runSetup;
    </script>
</body>
</html>
